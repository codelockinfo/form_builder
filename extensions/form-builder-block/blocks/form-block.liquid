<div id="easy-form-{{ block.id }}" class="form-builder-container" style="width: {{ block.settings.form_width }}%; margin: 0 auto; text-align: {{ block.settings.form_alignment }};">
  <div class="form-loading">Loading form...</div>
</div>

<script>
// Run immediately, don't wait for DOMContentLoaded in design mode
(function() {
  // Check if we're in design mode - if so, run immediately
  {% if request.design_mode %}
    // In design mode, run immediately
    (async function() {
      await initializeFormBuilder();
    })();
  {% else %}
    // On live storefront, wait for DOMContentLoaded
    document.addEventListener("DOMContentLoaded", async () => {
      await initializeFormBuilder();
    });
  {% endif %}
  
  async function initializeFormBuilder() {
  const blockContainer = document.getElementById("easy-form-{{ block.id }}");
  // Try different shop domain formats - Shopify might use different formats
  let shop = "{{ shop.permanent_domain }}";
  if (!shop || shop === "") {
    shop = "{{ shop.myshopify_domain }}";
  }
  if (!shop || shop === "") {
    shop = "{{ shop.domain }}";
  }
  // Fallback: try to get from window.location if available
  if (!shop || shop === "") {
    try {
      const hostname = window.location.hostname;
      if (hostname && hostname.includes('.myshopify.com')) {
        shop = hostname;
      }
    } catch(e) {
      console.warn('Could not get shop from window.location');
    }
  }
  
  console.log('=== Easy Form Builder Initialization ===');
  console.log('Block ID:', '{{ block.id }}');
  console.log('Shop permanent_domain:', "{{ shop.permanent_domain }}");
  console.log('Shop myshopify_domain:', "{{ shop.myshopify_domain }}");
  console.log('Shop domain:', "{{ shop.domain }}");
  console.log('Final shop value:', shop);
  console.log('Current form_id:', '{{ block.settings.form_id }}');
  
  // In Theme Editor
  {% if request.design_mode %}
    try {
      console.log('=== DESIGN MODE: Loading forms list ===');
      console.log('Fetching from: /apps/easy-form-builder/list?shop=' + shop);
      
      // Load form list from your PHP app (App Proxy)
      const listUrl = `/apps/easy-form-builder/list?shop=${encodeURIComponent(shop)}`;
      console.log('Full URL:', listUrl);
      
      const response = await fetch(listUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });
      
      console.log('Response status:', response.status);
      console.log('Response headers:', Object.fromEntries(response.headers.entries()));
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Forms list error response:', errorText);
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>‚ùå Error Loading Forms</strong><br>' +
          '<small>Status: ' + response.status + ' ' + response.statusText + '</small><br>' +
          '<small style="margin-top: 10px; display: block;">Error: ' + errorText.substring(0, 200) + '</small><br>' +
          '<small style="margin-top: 10px; display: block;">URL: ' + listUrl + '</small><br>' +
          '<small style="margin-top: 10px; display: block;">Check browser console (F12) for details.</small>' +
          '</div>';
        return;
      }
      
      const responseData = await response.json();
      console.log('‚úÖ Forms list response received:', responseData);
      console.log('Response type:', typeof responseData);
      console.log('Is array?', Array.isArray(responseData));
      
      // Extract forms array from response
      let formList = [];
      if (Array.isArray(responseData)) {
        formList = responseData;
      } else if (responseData && Array.isArray(responseData.forms)) {
        formList = responseData.forms;
      } else if (responseData && responseData.forms && typeof responseData.forms === 'object') {
        // Handle case where forms might be an object
        formList = Object.values(responseData.forms);
      }
      
      console.log('Extracted formList:', formList);
      console.log('Form count:', formList.length);
      
      if (!Array.isArray(formList)) {
        console.error('‚ùå Invalid response format:', responseData);
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>‚ùå Invalid Response Format</strong><br>' +
          '<small>Expected array but got: ' + typeof responseData + '</small><br>' +
          '<small>Response: ' + JSON.stringify(responseData).substring(0, 200) + '</small>' +
          '</div>';
        return;
      }
      
      if (formList.length === 0) {
        console.warn('‚ö†Ô∏è No forms found in response');
        blockContainer.innerHTML = '<div style="padding: 20px; color: #637381; text-align: center; border: 1px solid #e1e3e5; border-radius: 4px; background: #f6f6f7;">' +
          '<strong>No forms found</strong><br>' +
          '<small>Please create forms in your app first.</small><br>' +
          '<small style="margin-top: 10px; display: block; color: #999;">Shop: ' + shop + '</small><br>' +
          '<small style="margin-top: 5px; display: block; color: #999;">Check browser console (F12) for details.</small>' +
          '</div>';
        return;
      }
      
      // First, clear any invalid form_id (hash values) before using it
      const currentFormId = '{{ block.settings.form_id | default: "0" }}';
      const numericCurrentId = parseInt(currentFormId);
      const validFormId = (numericCurrentId && numericCurrentId > 0 && !isNaN(numericCurrentId)) ? numericCurrentId : 0;
      
      console.log('Current form_id:', currentFormId, '‚Üí Valid ID:', validFormId);
      
      let html = '<div style="padding: 20px; border: 2px solid #008060; border-radius: 6px; background: #f0fdf4;">';
      html += '<div style="margin-bottom: 15px;">';
      html += '<label style="font-weight: bold; display: block; margin-bottom: 10px; font-size: 16px; color: #008060;">üìã Select Form</label>';
      html += '<select id="select-form-{{ block.id }}" style="width: 100%; padding: 12px; border: 2px solid #008060; border-radius: 4px; font-size: 14px; background: white; cursor: pointer;">';
      html += '<option value="0">-- Select a form --</option>';
      
      formList.forEach(form => {
        const selected = form.id == validFormId ? 'selected' : '';
        html += `<option value="${form.id}" ${selected}>${form.name} (ID: ${form.id})</option>`;
      });
      
      html += '</select>';
      html += '</div>';
      html += '<div style="padding: 10px; background: white; border-radius: 4px; font-size: 12px; color: #637381;">';
      html += '<strong>Selected Form ID:</strong> <span id="current-form-id-{{ block.id }}" style="font-weight: bold; color: #008060;">' + (validFormId > 0 ? validFormId : 'None') + '</span>';
      html += '</div>';
      html += '</div>';
      
      blockContainer.innerHTML = html;
      console.log('Dropdown HTML created and inserted');
      
      // Save selected form into block settings
      const selectElement = document.getElementById("select-form-{{ block.id }}");
      
      selectElement.addEventListener("change", async (e) => {
        const formId = e.target.value;
        const numericFormId = parseInt(formId);
        const currentFormIdSpan = document.getElementById("current-form-id-{{ block.id }}");
        
        console.log('Form selected:', formId, 'Numeric ID:', numericFormId);
        
        if (currentFormIdSpan) {
          currentFormIdSpan.textContent = numericFormId || "None";
        }
        
        if (Shopify && Shopify.designMode && Shopify.theme && Shopify.theme.editor) {
          try {
            // Save as string but ensure it's a valid number
            await Shopify.theme.editor.setBlockSettings({
              id: "{{ block.id }}",
              settings: {
                form_id: numericFormId ? String(numericFormId) : ""
              }
            });
            
            console.log('Block settings saved with form_id:', numericFormId);
            
            // Preview the selected form
            if (numericFormId && numericFormId > 0) {
              await loadFormPreview(numericFormId);
            } else {
              blockContainer.querySelector('.form-loading')?.remove();
              const previewDiv = blockContainer.querySelector('.form-preview');
              if (previewDiv) {
                previewDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #637381;">Please select a form</div>';
              }
            }
          } catch (error) {
            console.error('Error saving form selection:', error);
            alert('Error saving form selection: ' + error.message);
          }
        }
      });
      
      // Load preview if form is already selected
      const currentFormId = {{ block.settings.form_id | default: 0 }};
      const numericCurrentId = parseInt(currentFormId);
      console.log('Current form ID from settings:', currentFormId, 'Numeric:', numericCurrentId);
      if (numericCurrentId && numericCurrentId > 0) {
        await loadFormPreview(numericCurrentId);
      } else if (currentFormId && currentFormId !== "" && currentFormId !== "0") {
        console.warn('Invalid form ID format:', currentFormId, '- Please select a form from the dropdown');
        // Clear invalid form ID
        if (Shopify && Shopify.designMode && Shopify.theme && Shopify.theme.editor) {
          await Shopify.theme.editor.setBlockSettings({
            id: "{{ block.id }}",
            settings: {
              form_id: ""
            }
          });
        }
      }
      
    } catch (error) {
      console.error('Error loading form list:', error);
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; border: 1px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>Error loading forms:</strong><br>' +
        error.message + '<br><br>' +
        '<small>Check browser console (F12) for details.<br>' +
        'Verify App Proxy is configured in Partner Dashboard.</small>' +
        '</div>';
    }
    
    async function loadFormPreview(formId) {
      try {
        const numericFormId = parseInt(formId);
        if (!numericFormId || numericFormId <= 0) {
          throw new Error('Invalid form ID: ' + formId);
        }
        
        // Create preview container if it doesn't exist
        let previewDiv = blockContainer.querySelector('.form-preview');
        if (!previewDiv) {
          previewDiv = document.createElement('div');
          previewDiv.className = 'form-preview';
          previewDiv.style.cssText = 'margin-top: 20px; padding: 15px; border: 1px solid #e1e3e5; border-radius: 4px; background: white;';
          blockContainer.appendChild(previewDiv);
        }
        
        previewDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form preview...</div>';
        
        console.log('Loading form preview for ID:', numericFormId, 'shop:', shop);
        const formResponse = await fetch(`/apps/easy-form-builder/render?form_id=${numericFormId}&shop=${shop}`);
        
        console.log('Preview response status:', formResponse.status);
        
        if (!formResponse.ok) {
          const errorText = await formResponse.text();
          console.error('Preview error response:', errorText);
          throw new Error(`Failed to load form: ${formResponse.status}`);
        }
        
        const formHtml = await formResponse.text();
        console.log('Preview HTML received, length:', formHtml.length);
        
        if (formHtml && formHtml.length > 0) {
          previewDiv.innerHTML = formHtml;
        } else {
          throw new Error('Empty form HTML received');
        }
        
        // Remove loading message if exists
        const loadingMsg = blockContainer.querySelector('.form-loading');
        if (loadingMsg) {
          loadingMsg.remove();
        }
      } catch (error) {
        console.error('Error loading form preview:', error);
        const previewDiv = blockContainer.querySelector('.form-preview');
        if (previewDiv) {
          previewDiv.innerHTML = '<div style="padding: 20px; color: #d32f2f;">Error loading form preview: ' + error.message + '</div>';
        }
      }
    }
    
  {% else %}
    // On Live Storefront: render selected form
    const formId = '{{ block.settings.form_id | default: "0" }}';
    
    // Validate formId is a number (not a hash)
    const numericFormId = parseInt(formId);
    
    console.log('=== LIVE STOREFRONT MODE ===');
    console.log('Form ID from settings:', formId, '‚Üí Numeric:', numericFormId);
    
    if (numericFormId && numericFormId > 0 && !isNaN(numericFormId)) {
      try {
        const loadingDiv = blockContainer.querySelector('.form-loading');
        if (loadingDiv) {
          loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
        } else {
          blockContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
        }
        
        console.log('Fetching form ID:', numericFormId, 'for shop:', shop);
        const renderUrl = `/apps/easy-form-builder/render?form_id=${numericFormId}&shop=${encodeURIComponent(shop)}`;
        console.log('Render URL:', renderUrl);
        
        const formResponse = await fetch(renderUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html',
            'Content-Type': 'text/html'
          }
        });
        
        console.log('Form response status:', formResponse.status);
        
        if (!formResponse.ok) {
          const errorText = await formResponse.text();
          console.error('Form response error:', errorText);
          throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
        }
        
        const formHtml = await formResponse.text();
        console.log('Form HTML received, length:', formHtml.length);
        
        if (formHtml && formHtml.trim().length > 0) {
          blockContainer.innerHTML = formHtml;
          console.log('‚úÖ Form HTML inserted');
          // Initialize form submission handler if needed
          initializeFormSubmission();
        } else {
          throw new Error('Empty form HTML received');
        }
      } catch (error) {
        console.error('‚ùå Error loading form:', error);
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>Error loading form</strong><br>' +
          error.message + '<br>' +
          '<small style="margin-top: 10px; display: block;">Check browser console (F12) for details.</small>' +
          '</div>';
      }
    } else {
      console.warn('‚ö†Ô∏è Invalid form ID:', formId, '- Not a valid number');
      blockContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #637381; border: 1px solid #e1e3e5; border-radius: 4px; background: #f6f6f7;">' +
        '<strong>No form selected</strong><br>' +
        '<small>Please select a form in Theme Customizer.</small>' +
        '</div>';
    }
    
    function initializeFormSubmission() {
      // Add form submission handling here if needed
      const form = blockContainer.querySelector('form.get_selected_elements');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          // Handle form submission
          console.log('Form submitted');
        });
      }
    }
  {% endif %}
});
</script>

{% schema %}
{
  "name": "Easy Form Builder",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "form_id",
      "label": "Form ID",
      "info": "This will be set automatically when you select a form from the dropdown above.",
      "default": "0"
    },
    {
      "type": "paragraph",
      "content": "üëÜ Select a form from the dropdown that appears in the preview area above. The Form ID will be set automatically."
    },
    {
      "type": "header",
      "content": "Form Display Settings"
    },
    {
      "type": "range",
      "id": "form_width",
      "label": "Form Width (%)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "form_alignment",
      "label": "Form Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}

<style>
.form-builder-container {
  width: 100%;
}

.form-loading {
  text-align: center;
  padding: 20px;
  color: #637381;
}

.form-preview {
  max-width: 100%;
}

/* Form styles - adjust as needed to match your form design */
.form-builder-container .formHeader {
  margin-bottom: 20px;
}

.form-builder-container .formHeader .title {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 10px;
}

.form-builder-container .formHeader .description {
  font-size: 14px;
  color: #637381;
}

.form-builder-container form {
  width: 100%;
}

.form-builder-container .code-form-control {
  margin-bottom: 20px;
}

.form-builder-container .footer {
  margin-top: 30px;
  text-align: left;
}

.form-builder-container .footer.forFooterAlign {
  text-align: left;
}

.form-builder-container .footer.forFooterAlign.align-center {
  text-align: center;
}

.form-builder-container .footer.forFooterAlign.align-right {
  text-align: right;
}
</style>