<div id="easy-form-{{ block.id }}" class="form-builder-container" style="width: {{ block.settings.form_width }}%; margin: 0 auto; text-align: {{ block.settings.form_alignment }};">
  <div class="form-loading">Loading form...</div>
</div>

<script>
// Multiple strategies to ensure code runs in Theme Customizer
(function() {
  'use strict';
  
  async function initializeFormBuilder() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    
    if (!blockContainer) {
      console.warn('Block container not found for: easy-form-{{ block.id }}');
      return false;
    }
  // Try different shop domain formats - Shopify might use different formats
  let shop = "{{ shop.permanent_domain }}";
  if (!shop || shop === "") {
    shop = "{{ shop.myshopify_domain }}";
  }
  if (!shop || shop === "") {
    shop = "{{ shop.domain }}";
  }
  // Fallback: try to get from window.location if available
  if (!shop || shop === "") {
    try {
      const hostname = window.location.hostname;
      if (hostname && hostname.includes('.myshopify.com')) {
        shop = hostname;
      }
    } catch(e) {
      console.warn('Could not get shop from window.location');
    }
  }
  
  console.log('=== Easy Form Builder Initialization ===');
  console.log('Block ID:', '{{ block.id }}');
  console.log('Shop permanent_domain:', "{{ shop.permanent_domain }}");
  console.log('Shop myshopify_domain:', "{{ shop.myshopify_domain }}");
  console.log('Shop domain:', "{{ shop.domain }}");
  console.log('Final shop value:', shop);
  console.log('Current form_id:', '{{ block.settings.form_id }}');
  
  // In Theme Editor
  {% if request.design_mode %}
    try {
      console.log('=== DESIGN MODE: Loading forms list ===');
      console.log('Fetching from: /apps/easy-form-builder/list?shop=' + shop);
      
      // Load form list from your PHP app (App Proxy)
      // Use absolute URL if we're on Shopify's domain
      let listUrl = `/apps/easy-form-builder/list?shop=${encodeURIComponent(shop)}`;
      
      // If we're on a Shopify domain, make sure we use the correct protocol
      if (window.location.hostname.includes('.myshopify.com') || window.location.hostname.includes('shopify.com')) {
        // We're on Shopify, use relative URL (Shopify will proxy it)
        listUrl = `/apps/easy-form-builder/list?shop=${encodeURIComponent(shop)}`;
      }
      
      console.log('Full URL:', listUrl);
      console.log('Current location:', window.location.href);
      
      const response = await fetch(listUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        },
        credentials: 'same-origin' // Include cookies for same-origin requests
      });
      
      console.log('Response status:', response.status);
      console.log('Response headers:', Object.fromEntries(response.headers.entries()));
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('❌ Forms list error response:', errorText);
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>❌ Error Loading Forms</strong><br>' +
          '<small>Status: ' + response.status + ' ' + response.statusText + '</small><br>' +
          '<small style="margin-top: 10px; display: block;">Error: ' + errorText.substring(0, 200) + '</small><br>' +
          '<small style="margin-top: 10px; display: block;">URL: ' + listUrl + '</small><br>' +
          '<small style="margin-top: 10px; display: block;">Check browser console (F12) for details.</small>' +
          '</div>';
        return;
      }
      
      const responseData = await response.json();
      console.log('✅ Forms list response received:', responseData);
      console.log('Response type:', typeof responseData);
      console.log('Is array?', Array.isArray(responseData));
      
      // Extract forms array from response
      let formList = [];
      if (Array.isArray(responseData)) {
        formList = responseData;
      } else if (responseData && Array.isArray(responseData.forms)) {
        formList = responseData.forms;
      } else if (responseData && responseData.forms && typeof responseData.forms === 'object') {
        // Handle case where forms might be an object
        formList = Object.values(responseData.forms);
      }
      
      console.log('Extracted formList:', formList);
      console.log('Form count:', formList.length);
      
      if (!Array.isArray(formList)) {
        console.error('❌ Invalid response format:', responseData);
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>❌ Invalid Response Format</strong><br>' +
          '<small>Expected array but got: ' + typeof responseData + '</small><br>' +
          '<small>Response: ' + JSON.stringify(responseData).substring(0, 200) + '</small>' +
          '</div>';
        return;
      }
      
      if (formList.length === 0) {
        console.warn('⚠️ No forms found in response');
        blockContainer.innerHTML = '<div style="padding: 20px; color: #637381; text-align: center; border: 1px solid #e1e3e5; border-radius: 4px; background: #f6f6f7;">' +
          '<strong>No forms found</strong><br>' +
          '<small>Please create forms in your app first.</small><br>' +
          '<small style="margin-top: 10px; display: block; color: #999;">Shop: ' + shop + '</small><br>' +
          '<small style="margin-top: 5px; display: block; color: #999;">Check browser console (F12) for details.</small>' +
          '</div>';
        return;
      }
      
      // First, clear any invalid form_id (hash values) before using it
      const currentFormId = '{{ block.settings.form_id | default: "0" }}';
      const numericCurrentId = parseInt(currentFormId);
      let validFormId = (numericCurrentId && numericCurrentId > 0 && !isNaN(numericCurrentId)) ? numericCurrentId : 0;
      
      // If form_id is a hash (long alphanumeric string), clear it
      if (currentFormId && currentFormId.length > 10 && !/^\d+$/.test(currentFormId)) {
        console.warn('⚠️ Invalid form_id (hash detected):', currentFormId, '- Clearing it');
        validFormId = 0;
        if (Shopify && Shopify.designMode && Shopify.theme && Shopify.theme.editor) {
          try {
            await Shopify.theme.editor.setBlockSettings({
              id: "{{ block.id }}",
              settings: { form_id: "0" }
            });
            console.log('✅ Cleared invalid form_id');
          } catch(e) {
            console.error('Error clearing form_id:', e);
          }
        }
      }
      
      console.log('Current form_id:', currentFormId, '→ Valid ID:', validFormId);
      
      // Populate the select dropdown in the settings panel (right sidebar)
      // Try multiple selectors to find the settings select element
      let settingsSelect = null;
      const selectors = [
        'select[data-setting-id="form_id"]',
        'select[name*="form_id"]',
        '.shopify-block-settings select[name*="form_id"]',
        'select[data-setting="form_id"]',
        '[data-setting-id="form_id"] select'
      ];
      
      for (const selector of selectors) {
        settingsSelect = document.querySelector(selector);
        if (settingsSelect) {
          console.log('✅ Found settings select element using selector:', selector);
          break;
        }
      }
      
      if (settingsSelect) {
        // Clear existing options except the first one
        while (settingsSelect.options.length > 1) {
          settingsSelect.remove(1);
        }
        
        // Add form options
        formList.forEach(form => {
          const option = document.createElement('option');
          option.value = form.id;
          option.textContent = form.name + ' (ID: ' + form.id + ')';
          if (form.id == validFormId) {
            option.selected = true;
          }
          settingsSelect.appendChild(option);
        });
        
        // Set the current value
        if (validFormId > 0) {
          settingsSelect.value = validFormId;
        }
        
        // Add change event listener to save when form is selected
        const changeHandler = async function(e) {
          const formId = e.target.value;
          const numericFormId = parseInt(formId);
          
          console.log('Form selected in settings:', formId, 'Numeric ID:', numericFormId);
          
          if (Shopify && Shopify.designMode && Shopify.theme && Shopify.theme.editor) {
            try {
              await Shopify.theme.editor.setBlockSettings({
                id: "{{ block.id }}",
                settings: {
                  form_id: numericFormId ? String(numericFormId) : "0"
                }
              });
              
              console.log('✅ Block settings saved with form_id:', numericFormId);
              
              // Load preview of selected form
              if (numericFormId && numericFormId > 0) {
                await loadFormPreview(numericFormId);
              } else {
                blockContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #637381; border: 1px dashed #e1e3e5; border-radius: 4px;">Please select a form from the settings panel on the right →</div>';
              }
            } catch (error) {
              console.error('Error saving form selection:', error);
            }
          }
        };
        
        // Remove existing listener if any, then add new one
        settingsSelect.removeEventListener('change', changeHandler);
        settingsSelect.addEventListener('change', changeHandler);
        
        console.log('✅ Settings panel dropdown populated with ' + formList.length + ' forms');
      } else {
        console.warn('⚠️ Could not find settings select element. Retrying in 500ms...');
        // Retry after a delay (settings panel might not be ready yet)
        setTimeout(() => {
          for (const selector of selectors) {
            const retrySelect = document.querySelector(selector);
            if (retrySelect) {
              console.log('✅ Found settings select on retry');
              // Same population logic as above
              while (retrySelect.options.length > 1) {
                retrySelect.remove(1);
              }
              formList.forEach(form => {
                const option = document.createElement('option');
                option.value = form.id;
                option.textContent = form.name + ' (ID: ' + form.id + ')';
                if (form.id == validFormId) {
                  option.selected = true;
                }
                retrySelect.appendChild(option);
              });
              if (validFormId > 0) {
                retrySelect.value = validFormId;
              }
              break;
            }
          }
        }, 500);
      }
      
      // Show preview area (not the dropdown) - just a container for the form
      blockContainer.innerHTML = '<div class="form-preview-container"></div>';
      
      // Load preview if form is already selected
      if (validFormId && validFormId > 0) {
        console.log('Loading preview for already selected form ID:', validFormId);
        await loadFormPreview(validFormId);
      } else {
        blockContainer.querySelector('.form-preview-container').innerHTML = '<div style="padding: 20px; text-align: center; color: #637381; border: 1px dashed #e1e3e5; border-radius: 4px;">Please select a form from the settings panel on the right →</div>';
      }
      
    } catch (error) {
      console.error('Error loading form list:', error);
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; border: 1px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>Error loading forms:</strong><br>' +
        error.message + '<br><br>' +
        '<small>Check browser console (F12) for details.<br>' +
        'Verify App Proxy is configured in Partner Dashboard.</small>' +
        '</div>';
    }
    
    async function loadFormPreview(formId) {
      try {
        const numericFormId = parseInt(formId);
        if (!numericFormId || numericFormId <= 0) {
          throw new Error('Invalid form ID: ' + formId);
        }
        
        // Use the preview container
        let previewDiv = blockContainer.querySelector('.form-preview-container');
        if (!previewDiv) {
          previewDiv = document.createElement('div');
          previewDiv.className = 'form-preview-container';
          blockContainer.appendChild(previewDiv);
        }
        
        previewDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #637381;">Loading form preview...</div>';
        
        console.log('Loading form preview for ID:', numericFormId, 'shop:', shop);
        const renderUrl = `/apps/easy-form-builder/render?form_id=${numericFormId}&shop=${encodeURIComponent(shop)}`;
        console.log('Preview render URL:', renderUrl);
        const formResponse = await fetch(renderUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html'
          },
          credentials: 'same-origin'
        });
        
        console.log('Preview response status:', formResponse.status);
        
        if (!formResponse.ok) {
          const errorText = await formResponse.text();
          console.error('Preview error response:', errorText);
          throw new Error(`Failed to load form: ${formResponse.status}`);
        }
        
        const formHtml = await formResponse.text();
        console.log('Preview HTML received, length:', formHtml.length);
        
        if (formHtml && formHtml.length > 0) {
          previewDiv.innerHTML = formHtml;
        } else {
          throw new Error('Empty form HTML received');
        }
        
        // Remove loading message if exists
        const loadingMsg = blockContainer.querySelector('.form-loading');
        if (loadingMsg) {
          loadingMsg.remove();
        }
      } catch (error) {
        console.error('Error loading form preview:', error);
        const previewDiv = blockContainer.querySelector('.form-preview-container');
        if (previewDiv) {
          previewDiv.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center;">Error loading form preview: ' + error.message + '</div>';
        }
      }
    }
    
  {% else %}
    // On Live Storefront: render selected form
    const formId = '{{ block.settings.form_id | default: "0" }}';
    
    // Validate formId is a number (not a hash)
    const numericFormId = parseInt(formId);
    
    console.log('=== LIVE STOREFRONT MODE ===');
    console.log('Form ID from settings:', formId, '→ Numeric:', numericFormId);
    
    if (numericFormId && numericFormId > 0 && !isNaN(numericFormId)) {
      try {
        const loadingDiv = blockContainer.querySelector('.form-loading');
        if (loadingDiv) {
          loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
        } else {
          blockContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
        }
        
        console.log('Fetching form ID:', numericFormId, 'for shop:', shop);
        const renderUrl = `/apps/easy-form-builder/render?form_id=${numericFormId}&shop=${encodeURIComponent(shop)}`;
        console.log('Render URL:', renderUrl);
        
        const formResponse = await fetch(renderUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html',
            'Content-Type': 'text/html'
          }
        });
        
        console.log('Form response status:', formResponse.status);
        
        if (!formResponse.ok) {
          const errorText = await formResponse.text();
          console.error('Form response error:', errorText);
          throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
        }
        
        const formHtml = await formResponse.text();
        console.log('Form HTML received, length:', formHtml.length);
        
        if (formHtml && formHtml.trim().length > 0) {
          blockContainer.innerHTML = formHtml;
          console.log('✅ Form HTML inserted');
          // Initialize form submission handler if needed
          initializeFormSubmission();
        } else {
          throw new Error('Empty form HTML received');
        }
      } catch (error) {
        console.error('❌ Error loading form:', error);
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>Error loading form</strong><br>' +
          error.message + '<br>' +
          '<small style="margin-top: 10px; display: block;">Check browser console (F12) for details.</small>' +
          '</div>';
      }
    } else {
      console.warn('⚠️ Invalid form ID:', formId, '- Not a valid number');
      blockContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #637381; border: 1px solid #e1e3e5; border-radius: 4px; background: #f6f6f7;">' +
        '<strong>No form selected</strong><br>' +
        '<small>Please select a form in Theme Customizer.</small>' +
        '</div>';
    }
    
    function initializeFormSubmission() {
      // Add form submission handling here if needed
      const form = blockContainer.querySelector('form.get_selected_elements');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          // Handle form submission
          console.log('Form submitted');
        });
      }
    }
  {% endif %}
    
    return true; // Success
  } // End of initializeFormBuilder
  
  // Multiple strategies to ensure code runs in Theme Customizer
  {% if request.design_mode %}
    // Strategy 1: Run immediately if DOM is ready
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initializeFormBuilder();
    } else {
      document.addEventListener('DOMContentLoaded', initializeFormBuilder);
    }
    
    // Strategy 2: Retry after delays (Theme Customizer loads blocks dynamically)
    setTimeout(() => initializeFormBuilder(), 100);
    setTimeout(() => initializeFormBuilder(), 500);
    setTimeout(() => initializeFormBuilder(), 1000);
    setTimeout(() => initializeFormBuilder(), 2000);
    
    // Strategy 3: Listen for Shopify theme editor events
    if (typeof Shopify !== 'undefined' && Shopify.designMode) {
      document.addEventListener('shopify:section:load', function() {
        setTimeout(initializeFormBuilder, 100);
      });
    }
  {% else %}
    // On live storefront
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeFormBuilder);
    } else {
      initializeFormBuilder();
    }
  {% endif %}
})();
</script>

{% schema %}
{
  "name": "Easy Form Builder",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "form_id",
      "label": "Select Form",
      "options": [
        {
          "value": "0",
          "label": "-- Loading forms... --"
        }
      ],
      "default": "0",
      "info": "Select a form to display. Forms are loaded dynamically from your app."
    },
    {
      "type": "header",
      "content": "Form Display Settings"
    },
    {
      "type": "range",
      "id": "form_width",
      "label": "Form Width (%)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "form_alignment",
      "label": "Form Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}

<style>
.form-builder-container {
  width: 100%;
}

.form-loading {
  text-align: center;
  padding: 20px;
  color: #637381;
}

.form-preview {
  max-width: 100%;
}

/* Form styles - adjust as needed to match your form design */
.form-builder-container .formHeader {
  margin-bottom: 20px;
}

.form-builder-container .formHeader .title {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 10px;
}

.form-builder-container .formHeader .description {
  font-size: 14px;
  color: #637381;
}

.form-builder-container form {
  width: 100%;
}

.form-builder-container .code-form-control {
  margin-bottom: 20px;
}

.form-builder-container .footer {
  margin-top: 30px;
  text-align: left;
}

.form-builder-container .footer.forFooterAlign {
  text-align: left;
}

.form-builder-container .footer.forFooterAlign.align-center {
  text-align: center;
}

.form-builder-container .footer.forFooterAlign.align-right {
  text-align: right;
}
</style>