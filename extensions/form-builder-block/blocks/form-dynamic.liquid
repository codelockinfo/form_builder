{% comment %}
  Dynamic Form Builder Block
  This is a SINGLE reusable block that works for ALL forms
  User enters Form ID in theme customizer settings
{% endcomment %}

<div id="easy-form-{{ block.id }}" 
     class="form-builder-container" 
     data-form-id="{{ block.settings.form_id }}"
     style="width: {{ block.settings.form_width }}%; margin: 0 auto; text-align: {{ block.settings.form_alignment }};">
  <div class="form-loading">Loading form...</div>
</div>

<script>
// Multiple strategies to ensure code runs in Theme Customizer
(function() {
  'use strict';
  
  async function initializeFormBuilder() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    
    if (!blockContainer) {
      console.warn('Block container not found for: easy-form-{{ block.id }}');
      return false;
    }
    
    // Get Form ID from block settings
    const formId = "{{ block.settings.form_id }}";
    
    // Validate Form ID (check for empty or default "0")
    if (!formId || formId.trim() === '' || formId.trim() === '0') {
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>⚠️ Form ID Required</strong><br>' +
        'Please enter a Form ID in the block settings to display the form.' +
        '</div>';
      console.warn('Form ID not provided in block settings');
      return false;
    }
    
    // Try different shop domain formats - Shopify might use different formats
    let shop = "{{ shop.permanent_domain }}";
    if (!shop || shop === "") {
      shop = "{{ shop.myshopify_domain }}";
    }
    if (!shop || shop === "") {
      shop = "{{ shop.domain }}";
    }
    // Fallback: try to get from window.location if available
    if (!shop || shop === "") {
      try {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      } catch(e) {
        console.warn('Could not get shop from window.location');
      }
    }
    
    console.log('=== Easy Form Builder Initialization ===');
    console.log('Block ID:', '{{ block.id }}');
    console.log('Form ID:', formId);
    console.log('Shop:', shop);
    
    // Load the form from app proxy
    try {
      const loadingDiv = blockContainer.querySelector('.form-loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      } else {
        blockContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      }
      
      console.log('Fetching form ID:', formId, 'for shop:', shop);
      const renderUrl = `/apps/easy-form-builder/render?form_id=${encodeURIComponent(formId)}&shop=${encodeURIComponent(shop)}`;
      console.log('Render URL:', renderUrl);
      
      const formResponse = await fetch(renderUrl, {
        method: 'GET',
        headers: {
          'Accept': 'text/html',
          'Content-Type': 'text/html'
        },
        credentials: 'same-origin'
      });
      
      console.log('Form response status:', formResponse.status);
      
      if (!formResponse.ok) {
        const errorText = await formResponse.text();
        console.error('Form response error:', errorText);
        throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
      }
      
      const formHtml = await formResponse.text();
      console.log('Form HTML received, length:', formHtml.length);
      
      if (formHtml && formHtml.trim().length > 0) {
        // Extract and execute scripts separately (innerHTML doesn't execute script tags)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formHtml;
        
        // Extract all script tags
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(function(oldScript) {
          const newScript = document.createElement('script');
          Array.from(oldScript.attributes).forEach(function(attr) {
            newScript.setAttribute(attr.name, attr.value);
          });
          newScript.textContent = oldScript.textContent;
          document.head.appendChild(newScript);
          oldScript.remove();
        });
        
        // Insert HTML without script tags
        blockContainer.innerHTML = tempDiv.innerHTML;
        console.log('✅ Form HTML inserted');
        
        // Initialize form submission handler
        initializeFormSubmission();
        // Initialize button hover effects
        initializeButtonHoverEffects();
        // Initialize floating form functionality
        initializeFloatingForm();
      } else {
        throw new Error('Empty form HTML received');
      }
    } catch (error) {
      console.error('❌ Error loading form:', error);
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>Error loading form</strong><br>' +
        error.message + '<br>' +
        '<small>Please check that the Form ID is correct and the form exists in your app.</small>' +
        '</div>';
    }
  }
  
  function initializeFormSubmission() {
    console.log('=== Initializing Form Submission Handlers ===');
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    const forms = blockContainer.querySelectorAll('form.get_selected_elements');
    console.log('Found forms:', forms.length);
    
    forms.forEach(function(form, index) {
      console.log('Processing form', index);
      
      // Get form ID
      const formIdInput = form.querySelector('input[name="form_id"], input.form_id');
      const formId = formIdInput ? formIdInput.value : form.getAttribute('data-id') || '';
      console.log('Form ID:', formId);
      
      if (!formId) {
        console.error('Form ID not found for form', index);
        return;
      }
      
      // Get shop domain
      let shop = "{{ shop.permanent_domain }}";
      if (!shop || shop === "") {
        shop = "{{ shop.myshopify_domain }}";
      }
      if (!shop || shop === "") {
        shop = "{{ shop.domain }}";
      }
      if (!shop || shop === "") {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      }
      console.log('Shop domain:', shop);
      
      // Form submit handler
      function handleFormSubmit(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('=== FORM SUBMIT EVENT ===');
        console.log('Form:', form);
        console.log('Form ID:', formId);
        console.log('Shop:', shop);
        
        // Create FormData - collect ALL form fields
        const formData = new FormData(form);
        
        // Log all form inputs before creating FormData
        console.log('=== Form Inputs Debug ===');
        const allInputs = form.querySelectorAll('input, textarea, select');
        console.log('Total inputs found:', allInputs.length);
        allInputs.forEach(function(input, idx) {
          const name = input.name || input.getAttribute('name') || 'NO_NAME';
          const value = input.value || input.getAttribute('value') || '';
          const type = input.type || input.tagName.toLowerCase();
          console.log(`Input ${idx}: name="${name}", type="${type}", value="${value.substring(0, 50)}"`);
        });
        
        // Add system fields
        formData.append('store', shop);
        formData.append('routine_name', 'addformdata');
        formData.append('form_id', formId);
        
        // Log FormData entries
        console.log('=== FormData Entries ===');
        const formDataEntries = Array.from(formData.entries());
        console.log('Total FormData entries:', formDataEntries.length);
        formDataEntries.forEach(function(entry, idx) {
          console.log(`Entry ${idx}: ${entry[0]} = ${entry[1].toString().substring(0, 100)}`);
        });
        
        // Verify we have actual form data (not just system fields)
        const formFieldNames = [];
        formDataEntries.forEach(function(entry) {
          const key = entry[0];
          if (key !== 'store' && key !== 'routine_name' && key !== 'form_id' && key !== 'id') {
            formFieldNames.push(key);
          }
        });
        console.log('Form field names (excluding system fields):', formFieldNames);
        
        if (formFieldNames.length === 0) {
          console.error('ERROR: No form fields found! Form might be empty or fields have no name attributes.');
          console.error('Form HTML:', form.outerHTML.substring(0, 500));
          alert('Error: Form fields not found. Please check form configuration. Check console for details.');
          return false;
        }
        
        // Disable submit button
        const submitBtn = form.querySelector('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.6';
          const originalText = submitBtn.innerHTML;
          submitBtn.setAttribute('data-original-text', originalText);
          submitBtn.innerHTML = 'Submitting...';
        }
        
        // Get AJAX URL
        const ajaxUrl = 'https://codelocksolutions.com/form_builder/user/ajax_call.php';
        console.log('Submitting to:', ajaxUrl);
        
        // Submit via fetch
        console.log('=== Sending AJAX Request ===');
        console.log('URL:', ajaxUrl);
        console.log('Method: POST');
        console.log('FormData entries count:', formDataEntries.length);
        
        fetch(ajaxUrl, {
          method: 'POST',
          body: formData
        })
        .then(function(response) {
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);
          return response.text();
        })
        .then(function(responseText) {
          console.log('Response text:', responseText);
          let data;
          try {
            data = JSON.parse(responseText);
          } catch(e) {
            console.error('Failed to parse JSON:', e);
            console.error('Response was:', responseText);
            throw new Error('Invalid JSON response: ' + responseText.substring(0, 200));
          }
          console.log('Parsed response data:', data);
          
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
              submitBtn.innerHTML = originalText;
            }
          }
          
          if (data.result === 'success') {
            alert(data.msg || 'Form submitted successfully!');
            form.reset();
            console.log('Form reset');
          } else {
            alert(data.msg || 'Something went wrong. Please try again.');
          }
        })
        .catch(function(error) {
          console.error('Submission error:', error);
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
              submitBtn.innerHTML = originalText;
            }
          }
          alert('An error occurred. Please check the console.');
        });
        
        return false;
      }
      
      // Attach submit handler to form
      form.addEventListener('submit', handleFormSubmit);
      console.log('Submit handler attached to form', index);
      
      // Also attach to submit buttons
      const submitButtons = form.querySelectorAll('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit, button.action.submit.classic-button');
      console.log('Found submit buttons:', submitButtons.length);
      
      submitButtons.forEach(function(btn, btnIndex) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('=== SUBMIT BUTTON CLICKED ===', btnIndex);
          handleFormSubmit(e);
        });
        console.log('Click handler attached to button', btnIndex);
      });
    });
  }
  
  function initializeButtonHoverEffects() {
    // Initialize hover effects for buttons with data-hover-bg attribute
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    const buttons = blockContainer.querySelectorAll('.footer .action.submit.classic-button[data-hover-bg], .footer .action.reset.classic-button[data-hover-bg]');
    
    buttons.forEach(function(button) {
      const hoverBg = button.getAttribute('data-hover-bg');
      
      if (hoverBg) {
        // Get original colors from inline style attribute
        const styleAttr = button.getAttribute('style') || '';
        let originalBg = '';
        let originalBorder = '';
        
        // Extract background-color and border-color from style attribute
        const bgMatch = styleAttr.match(/background-color:\s*([^;]+)/i);
        const borderMatch = styleAttr.match(/border-color:\s*([^;]+)/i);
        
        if (bgMatch) {
          originalBg = bgMatch[1].trim();
        } else {
          // Fallback to computed style
          originalBg = window.getComputedStyle(button).backgroundColor;
        }
        
        if (borderMatch) {
          originalBorder = borderMatch[1].trim();
        } else {
          // Fallback to computed style
          originalBorder = window.getComputedStyle(button).borderColor;
        }
        
        // Store original colors
        button.setAttribute('data-original-bg', originalBg);
        button.setAttribute('data-original-border', originalBorder);
        
        // Mouse enter - apply hover color to both background and border
        button.addEventListener('mouseenter', function() {
          this.style.backgroundColor = hoverBg;
          this.style.borderColor = hoverBg;
        });
        
        // Mouse leave - restore original colors
        button.addEventListener('mouseleave', function() {
          const origBg = this.getAttribute('data-original-bg') || originalBg;
          const origBorder = this.getAttribute('data-original-border') || originalBorder;
          this.style.backgroundColor = origBg;
          this.style.borderColor = origBorder;
        });
      }
    });
    
    console.log('Button hover effects initialized for', buttons.length, 'buttons');
  }
  
  function initializeFloatingForm() {
    // Initialize floating form popup functionality
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    // Check if this is a floating form (has the floating-form-icon element)
    const floatingIcon = blockContainer.querySelector('.floating-form-icon');
    if (!floatingIcon) {
      console.log('Not a floating form, skipping floating form initialization');
      return;
    }
    
    const overlay = blockContainer.querySelector('.floating-form-overlay');
    const closeBtn = blockContainer.querySelector('.floating-form-close');
    
    if (!overlay || !closeBtn) {
      console.warn('Floating form elements not found');
      return;
    }
    
    console.log('Initializing floating form functionality');
    
    // Open popup when icon is clicked
    floatingIcon.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      console.log('Floating form popup opened');
    });
    
    // Close popup when close button is clicked
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      overlay.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
      console.log('Floating form popup closed');
    });
    
    // Close popup when clicking outside the form
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
        console.log('Floating form popup closed (clicked outside)');
      }
    });
    
    // Close popup on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
        console.log('Floating form popup closed (Escape key)');
      }
    });
    
    console.log('Floating form initialized successfully');
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFormBuilder);
  } else {
    // DOM already loaded
    initializeFormBuilder();
  }
  
  // Also try after a short delay (for Theme Customizer)
  setTimeout(initializeFormBuilder, 100);
  
  // Listen for Shopify theme editor events
  if (typeof window.Shopify !== 'undefined' && window.Shopify.designMode) {
    document.addEventListener('shopify:section:load', initializeFormBuilder);
    document.addEventListener('shopify:block:select', initializeFormBuilder);
  }
})();
</script>

{% schema %}
{
  "name": "Easy Form Builder",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "text",
      "id": "form_id",
      "label": "Form ID",
      "info": "Enter the Form ID of the form you created in the Easy Form Builder app. You can find this ID in your app dashboard.",
      "default": "0"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "range",
      "id": "form_width",
      "label": "Form Width (%)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "form_alignment",
      "label": "Form Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}

