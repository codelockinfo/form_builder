{% comment %}
  Dynamic Form Builder Block
  This is a SINGLE reusable block that works for ALL forms
  User enters Form ID in theme customizer settings
{% endcomment %}

<div id="easy-form-{{ block.id }}" 
     class="form-builder-container" 
     data-form-id="{{ block.settings.form_id }}"
     style="width: {{ block.settings.form_width }}%; margin: 0 auto; text-align: {{ block.settings.form_alignment }};">
  <div class="form-loading">Loading form...</div>
</div>

<script>
// Multiple strategies to ensure code runs in Theme Customizer
(function() {
  'use strict';
  
  async function initializeFormBuilder() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    
    if (!blockContainer) {
      return false;
    }
    
    // Get Form ID from block settings
    const formId = "{{ block.settings.form_id }}";
    
    // Validate Form ID (check for empty or default "0")
    if (!formId || formId.trim() === '' || formId.trim() === '0') {
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>⚠️ Form ID Required</strong><br>' +
        'Please enter a Form ID in the block settings to display the form.' +
        '</div>';
      return false;
    }
    
    // Try different shop domain formats - Shopify might use different formats
    let shop = "{{ shop.permanent_domain }}";
    if (!shop || shop === "") {
      shop = "{{ shop.myshopify_domain }}";
    }
    if (!shop || shop === "") {
      shop = "{{ shop.domain }}";
    }
    // Fallback: try to get from window.location if available
    if (!shop || shop === "") {
      try {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      } catch(e) {
      }
    }
    
    // Load the form from app proxy
    try {
      const loadingDiv = blockContainer.querySelector('.form-loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      } else {
        blockContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      }
      
      const renderUrl = `/apps/easy-form-builder/render?form_id=${encodeURIComponent(formId)}&shop=${encodeURIComponent(shop)}`;
      
      const formResponse = await fetch(renderUrl, {
        method: 'GET',
        headers: {
          'Accept': 'text/html',
          'Content-Type': 'text/html'
        },
        credentials: 'same-origin'
      });
      
      if (!formResponse.ok) {
        // If 404, form doesn't exist - show error
        if (formResponse.status === 404) {
          throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
        } else {
          // For other errors, also show error
          throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
        }
      }
      
      const formHtml = await formResponse.text();
      
      // If form HTML is empty (form is disabled), hide the container
      if (!formHtml || formHtml.trim().length === 0) {
        blockContainer.style.display = 'none';
        return false;
      }
      
      if (formHtml && formHtml.trim().length > 0) {
        try {
          // Basic HTML sanitization - remove any malformed tags or content
          let sanitizedHtml = formHtml;
          
          // Remove any unclosed script tags or malformed script content
          sanitizedHtml = sanitizedHtml.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, function(match) {
            try {
              // Try to parse the script content to check if it's valid
              const scriptMatch = match.match(/<script[^>]*>([\s\S]*?)<\/script>/i);
              if (scriptMatch && scriptMatch[1]) {
                const scriptContent = scriptMatch[1].trim();
                // Skip if content looks malformed (contains unmatched brackets)
                const openBraces = (scriptContent.match(/\{/g) || []).length;
                const closeBraces = (scriptContent.match(/\}/g) || []).length;
                const openParens = (scriptContent.match(/\(/g) || []).length;
                const closeParens = (scriptContent.match(/\)/g) || []).length;
                
                // If braces or parens don't match, skip this script
                if (Math.abs(openBraces - closeBraces) > 2 || Math.abs(openParens - closeParens) > 2) {
                  return ''; // Remove malformed script
                }
              }
              return match; // Keep valid scripts
            } catch(e) {
              return ''; // Remove if we can't parse
            }
          });
          
          // Remove any stray HTML tags that might cause issues
          sanitizedHtml = sanitizedHtml.replace(/<if\b[^>]*>/gi, ''); // Remove stray <if> tags
          sanitizedHtml = sanitizedHtml.replace(/<endif\b[^>]*>/gi, ''); // Remove stray <endif> tags
          
          // Extract and execute scripts separately (innerHTML doesn't execute script tags)
          const tempDiv = document.createElement('div');
          
          // Try to set innerHTML with error handling
          try {
            tempDiv.innerHTML = sanitizedHtml;
          } catch(htmlError) {
            // If innerHTML fails, try to clean it more aggressively
            sanitizedHtml = sanitizedHtml.replace(/<[^>]*$/gm, ''); // Remove incomplete tags at end of lines
            sanitizedHtml = sanitizedHtml.replace(/[<>]/g, function(match, offset, string) {
              // Check if it's part of a valid tag
              const before = string.substring(Math.max(0, offset - 50), offset);
              const after = string.substring(offset + 1, Math.min(string.length, offset + 51));
              // If it looks like a stray bracket, remove it
              if (match === '<' && !after.match(/^[a-z\/!]/i)) return '';
              if (match === '>' && !before.match(/[a-z0-9"']$/i)) return '';
              return match;
            });
            tempDiv.innerHTML = sanitizedHtml;
          }
          
          // Extract all script tags - with error handling
          const scripts = tempDiv.querySelectorAll('script');
          scripts.forEach(function(oldScript, scriptIdx) {
            try {
              const scriptContent = oldScript.textContent || oldScript.innerHTML || '';
              // Skip empty scripts
              if (!scriptContent.trim()) {
                oldScript.remove();
                return;
              }
              
              // Validate script content before executing
              const openBraces = (scriptContent.match(/\{/g) || []).length;
              const closeBraces = (scriptContent.match(/\}/g) || []).length;
              const openParens = (scriptContent.match(/\(/g) || []).length;
              const closeParens = (scriptContent.match(/\)/g) || []).length;
              
              // Skip if braces or parens are severely mismatched
              if (Math.abs(openBraces - closeBraces) > 2 || Math.abs(openParens - closeParens) > 2) {
                oldScript.remove();
                return;
              }
              
              const newScript = document.createElement('script');
              Array.from(oldScript.attributes).forEach(function(attr) {
                try {
                  newScript.setAttribute(attr.name, attr.value);
                } catch(attrError) {
                  // Skip invalid attributes
                }
              });
              newScript.textContent = scriptContent;
              
              // Use try-catch for appending
              try {
                document.head.appendChild(newScript);
              } catch(appendError) {
                // Try using eval as fallback (less ideal but works)
                try {
                  eval(scriptContent);
                } catch(evalError) {
                  // Silent fail - script was malformed
                }
              }
              oldScript.remove();
            } catch(scriptError) {
              // Remove the problematic script
              try {
                oldScript.remove();
              } catch(e) {
                // Ignore
              }
            }
          });
          
          // Insert HTML without script tags - with error handling
          try {
            blockContainer.innerHTML = tempDiv.innerHTML;
          } catch(insertError) {
            // If insertion fails, try to insert a cleaned version
            const cleanedHtml = tempDiv.innerHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
            blockContainer.innerHTML = cleanedHtml;
          }
        } catch(mainError) {
          // If all else fails, show error message
          blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
            '<strong>⚠️ Error Loading Form</strong><br>' +
            'There was an error loading the form. Please try refreshing the page.' +
            '</div>';
          return false;
        }
        
        // Remove readonly/disabled attributes from form fields so users can type
        const formInputs = blockContainer.querySelectorAll('input, textarea, select');
        formInputs.forEach(function(input, idx) {
          const name = input.name || input.getAttribute('name') || 'NO_NAME';
          const hadReadonly = input.hasAttribute('readonly');
          const wasDisabled = input.disabled;
          const hasTabindex = input.hasAttribute('tabindex');
          const tabindexValue = hasTabindex ? input.getAttribute('tabindex') : null;
          
          
          // Remove readonly
          if (hadReadonly) {
            input.removeAttribute('readonly');
          }
          
          // Enable disabled inputs
          if (wasDisabled) {
            input.disabled = false;
          }
          
          // Remove negative tabindex (which prevents keyboard focus)
          if (hasTabindex && tabindexValue === '-1') {
            input.removeAttribute('tabindex');
          }
          
          // Ensure input is focusable and editable
          input.style.pointerEvents = 'auto';
          input.style.userSelect = 'auto';
          
          // Verify the input is now editable
        });
        
        // Also use MutationObserver to catch any dynamically added readonly attributes
        if (typeof MutationObserver !== 'undefined') {
          const attrObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && (mutation.attributeName === 'readonly' || mutation.attributeName === 'disabled')) {
                const target = mutation.target;
                if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
                  if (target.hasAttribute('readonly')) {
                    target.removeAttribute('readonly');
                  }
                  if (target.disabled) {
                    target.disabled = false;
                  }
                }
              }
            });
          });
          
          formInputs.forEach(function(input) {
            attrObserver.observe(input, {
              attributes: true,
              attributeFilter: ['readonly', 'disabled']
            });
          });
          
        }
        
        // Initialize form fill tracking (track when user clicks/focuses on any input)
        initializeFormFillTracking();
        
        // Initialize form submission handler
        initializeFormSubmission();
        // Initialize button hover effects
        initializeButtonHoverEffects();
        // Initialize floating form functionality
        initializeFloatingForm();
      } else {
        // Empty form HTML - form is disabled, hide the container
        blockContainer.style.display = 'none';
        return false;
      }
    } catch (error) {
      // Only show error if it's a real error (not just empty form)
      // Check if error message indicates form is disabled
      if (error.message && error.message.includes('Empty form HTML')) {
        blockContainer.style.display = 'none';
        return false;
      }
      
      // Only show error for actual errors (404, 500, etc.), not for disabled forms
      if (error.message && !error.message.includes('Empty form HTML')) {
        blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
          '<strong>Error loading form</strong><br>' +
          error.message + '<br>' +
          '<small>Please check that the Form ID is correct and the form exists in your app.</small>' +
          '</div>';
      } else {
        // Form is disabled - just hide it
        blockContainer.style.display = 'none';
      }
    }
  }
  
  // Function to show inline notification messages (replaces alerts)
  function showNotification(message, type) {
    type = type || 'success'; // 'success' or 'error'
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) {
      // Fallback to alert if container not found
      // Silent fail
      return;
    }
    
    // Remove any existing notifications
    const existingNotification = blockContainer.querySelector('.form-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'form-notification form-notification-' + type;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#4caf50' : '#f44336'};
      color: white;
      padding: 16px 24px;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      font-size: 16px;
      font-weight: 500;
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    // Add animation styles if not already added
    if (!document.getElementById('form-notification-styles')) {
      const style = document.createElement('style');
      style.id = 'form-notification-styles';
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
        .form-notification {
          animation: slideIn 0.3s ease-out;
        }
        .form-notification.hiding {
          animation: slideOut 0.3s ease-out;
        }
      `;
      document.head.appendChild(style);
    }
    
    // Insert notification
    document.body.appendChild(notification);
    
    // Auto-dismiss after 3 seconds for success, 5 seconds for error
    const dismissTime = type === 'success' ? 3000 : 5000;
    setTimeout(function() {
      notification.classList.add('hiding');
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, dismissTime);
    
    // Also allow manual dismiss on click
    notification.style.cursor = 'pointer';
    notification.addEventListener('click', function() {
      notification.classList.add('hiding');
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    });
  }
  
  function initializeFormFillTracking() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) {
      return;
    }
    
    // Try multiple selectors to find the form
    let forms = blockContainer.querySelectorAll('form.get_selected_elements');
    if (forms.length === 0) {
      forms = blockContainer.querySelectorAll('form');
    }
    if (forms.length === 0) {
      // Try to find form by looking for form_id input
      const formIdInputs = blockContainer.querySelectorAll('input[name="form_id"], input.form_id');
      if (formIdInputs.length > 0) {
        forms = Array.from(formIdInputs).map(function(input) {
          return input.closest('form');
        }).filter(function(form) {
          return form !== null;
        });
      }
    }
    
    if (forms.length === 0) {
      setTimeout(function() {
        initializeFormFillTracking();
      }, 500);
      return;
    }
    
    forms.forEach(function(form, index) {
      // Get form ID - try multiple methods
      let formId = '';
      
      // Method 1: Look for hidden input with form_id
      const formIdInput = form.querySelector('input[name="form_id"], input.form_id');
      if (formIdInput) {
        formId = formIdInput.value || '';
      }
      
      // Method 2: Check data attribute
      if (!formId) {
        formId = form.getAttribute('data-id') || form.getAttribute('data-form-id') || '';
      }
      
      // Method 3: Check block container
      if (!formId && blockContainer) {
        formId = blockContainer.getAttribute('data-form-id') || '';
      }
      
      // Method 4: Get from block settings (fallback)
      if (!formId) {
        formId = "{{ block.settings.form_id }}" || '';
      }
      
      if (!formId || formId.trim() === '' || formId.trim() === '0') {
        return;
      }
      
      // Get shop domain
      let shop = "{{ shop.permanent_domain }}";
      if (!shop || shop === "") {
        shop = "{{ shop.myshopify_domain }}";
      }
      if (!shop || shop === "") {
        shop = "{{ shop.domain }}";
      }
      if (!shop || shop === "") {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      }
      
      if (!shop) {
        return;
      }
      
      // Track fill only once per form view (use data attribute to prevent multiple tracks)
      let fillTracked = form.getAttribute('data-fill-tracked');
      if (fillTracked === 'true') {
        return; // Already tracked
      }
      
      // Get all form inputs (input, textarea, select)
      const formInputs = form.querySelectorAll('input, textarea, select');
      
      // Track fill when user focuses or clicks on any input
      const trackFill = function(event) {
        // Check if already tracked
        if (form.getAttribute('data-fill-tracked') === 'true') {
          return; // Already tracked
        }
        
        // Mark as tracked immediately to prevent duplicate tracking
        form.setAttribute('data-fill-tracked', 'true');
        
        // Send AJAX request to track fill
        const formData = new FormData();
        formData.append('store', shop);
        formData.append('routine_name', 'trackFormFill');
        formData.append('form_id', formId);
        
        // Get base URL - try multiple methods
        let baseUrl = '';
        
        // Method 1: Try to get from script tags
        const scripts = document.querySelectorAll('script[src]');
        for (let i = 0; i < scripts.length; i++) {
          const src = scripts[i].src;
          if (src.indexOf('/form_builder/') > -1) {
            baseUrl = src.substring(0, src.indexOf('/form_builder/') + '/form_builder'.length);
            break;
          }
        }
        
        // Method 2: Try to get from current page URL
        if (!baseUrl) {
          const currentUrl = window.location.href;
          if (currentUrl.indexOf('/form_builder/') > -1) {
            baseUrl = currentUrl.substring(0, currentUrl.indexOf('/form_builder/') + '/form_builder'.length);
          }
        }
        
        // Method 3: Default to production URL
        if (!baseUrl) {
          baseUrl = 'https://codelocksolutions.com/form_builder';
        }
        
        const ajaxUrl = baseUrl + '/user/ajax_call.php';
        
        fetch(ajaxUrl, {
          method: 'POST',
          body: formData
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
          }
          return response.json();
        })
        .then(function(data) {
          // Silent success
        })
        .catch(function(error) {
          // Silent error
        });
      };
      
      // Attach event listeners to all inputs
      formInputs.forEach(function(input) {
        // Skip hidden inputs and submit buttons
        if (input.type === 'hidden' || input.type === 'submit' || input.type === 'button') {
          return;
        }
        
        // Track on focus (when user clicks into the field)
        input.addEventListener('focus', function(e) {
          trackFill(e);
        }, { once: true });
        
        // Also track on click (in case focus doesn't fire)
        input.addEventListener('click', function(e) {
          trackFill(e);
        }, { once: true });
        
        // Also track on input (when user starts typing)
        input.addEventListener('input', function(e) {
          trackFill(e);
        }, { once: true });
      });
    });
  }
  
  function initializeFormSubmission() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    const forms = blockContainer.querySelectorAll('form.get_selected_elements');
    
    forms.forEach(function(form, index) {
      
      // Get form ID
      const formIdInput = form.querySelector('input[name="form_id"], input.form_id');
      const formId = formIdInput ? formIdInput.value : form.getAttribute('data-id') || '';
      if (!formId) {
        return;
      }
      
      // Get shop domain
      let shop = "{{ shop.permanent_domain }}";
      if (!shop || shop === "") {
        shop = "{{ shop.myshopify_domain }}";
      }
      if (!shop || shop === "") {
        shop = "{{ shop.domain }}";
      }
      if (!shop || shop === "") {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      }
      
      // Form submit handler
      function handleFormSubmit(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Log all form inputs BEFORE modifying
        const allInputs = form.querySelectorAll('input, textarea, select');
        allInputs.forEach(function(input, idx) {
          const name = input.name || input.getAttribute('name') || 'NO_NAME';
          const value = input.value || input.getAttribute('value') || '';
          const type = input.type || input.tagName.toLowerCase();
          const disabled = input.disabled;
        });
        
        // Remove readonly/disabled attributes temporarily to ensure values are collected
        const readonlyInputs = form.querySelectorAll('input[readonly], textarea[readonly]');
        const disabledInputs = form.querySelectorAll('input[disabled], textarea[disabled]');
        const readonlyStates = [];
        const disabledStates = [];
        
        // Store and remove readonly
        readonlyInputs.forEach(function(input) {
          readonlyStates.push({element: input, name: input.name});
          input.removeAttribute('readonly');
        });
        
        // Store and enable disabled inputs
        disabledInputs.forEach(function(input) {
          disabledStates.push({element: input, name: input.name});
          input.disabled = false;
        });
        
        // Check if any values exist
        let hasAnyValue = false;
        allInputs.forEach(function(input, idx) {
          const value = input.value || input.getAttribute('value') || '';
          if (value.trim().length > 0) {
            hasAnyValue = true;
          }
        });
        
        // Warn if no values found
        if (!hasAnyValue) {
          // Test if we can set values programmatically
          allInputs.forEach(function(input, idx) {
            const testValue = 'TEST_VALUE_' + idx;
            const oldValue = input.value;
            input.value = testValue;
            // Restore old value
            input.value = oldValue;
          });
          
          // Show error notification
          showNotification('Error: Form fields appear to be empty. Please fill out the form before submitting.', 'error');
          return false; // Stop submission
        }
        
        // Create FormData AFTER removing readonly/disabled
        const formData = new FormData(form);
        
        // Restore readonly/disabled states immediately
        readonlyStates.forEach(function(state) {
          state.element.setAttribute('readonly', 'readonly');
        });
        disabledStates.forEach(function(state) {
          state.element.disabled = true;
        });
        
        // Add system fields
        formData.append('store', shop);
        formData.append('routine_name', 'addformdata');
        formData.append('form_id', formId);
        
        // Log FormData entries
        const formDataEntries = Array.from(formData.entries());
        formDataEntries.forEach(function(entry, idx) {
        });
        
        // Verify we have actual form data (not just system fields)
        const formFieldNames = [];
        formDataEntries.forEach(function(entry) {
          const key = entry[0];
          if (key !== 'store' && key !== 'routine_name' && key !== 'form_id' && key !== 'id') {
            formFieldNames.push(key);
          }
        });
        
        if (formFieldNames.length === 0) {
          showNotification('Error: Form fields not found. Please check form configuration.', 'error');
          return false;
        }
        
        // Disable submit button
        const submitBtn = form.querySelector('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.6';
          const originalText = submitBtn.innerHTML;
          submitBtn.setAttribute('data-original-text', originalText);
          submitBtn.innerHTML = 'Submitting...';
        }
        
        // Get AJAX URL
        const ajaxUrl = 'https://codelocksolutions.com/form_builder/user/ajax_call.php';
        
        // Submit via fetch
        
        fetch(ajaxUrl, {
          method: 'POST',
          body: formData
        })
        .then(function(response) {
          return response.text();
        })
        .then(function(responseText) {
          let data;
          try {
            data = JSON.parse(responseText);
          } catch(e) {
            throw new Error('Invalid JSON response: ' + responseText.substring(0, 200));
          }
          
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
              submitBtn.innerHTML = originalText;
            }
          }
          
          if (data.result === 'success') {
            showNotification(data.msg || 'Form submitted successfully!', 'success');
            form.reset();
          } else {
            showNotification(data.msg || 'Something went wrong. Please try again.', 'error');
          }
        })
        .catch(function(error) {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
              submitBtn.innerHTML = originalText;
            }
          }
          showNotification('An error occurred. Please try again.', 'error');
        });
        
        return false;
      }
      
      // Attach submit handler to form
      form.addEventListener('submit', handleFormSubmit);
      
      // Also attach to submit buttons - search more broadly
      // First try within form
      let submitButtons = form.querySelectorAll('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit, button.action.submit.classic-button, button.action.submit, .action.submit.classic-button.footer-data__submittext');
      
      // If none found, search in the block container (button might be outside form)
      if (submitButtons.length === 0) {
        submitButtons = blockContainer.querySelectorAll('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit, button.action.submit.classic-button, button.action.submit, .action.submit.classic-button.footer-data__submittext, button[class*="submit"], button[class*="action"]');
      }
      
      // Log all buttons found for debugging
      if (submitButtons.length === 0) {
        const allButtons = blockContainer.querySelectorAll('button');
        allButtons.forEach(function(btn, idx) {
          const classes = btn.className || '';
          const text = btn.textContent || btn.innerText || '';
        });
      }
      
      submitButtons.forEach(function(btn, btnIndex) {
        // Remove any existing listeners by cloning
        const newBtn = btn.cloneNode(true);
        if (btn.parentNode) {
          btn.parentNode.replaceChild(newBtn, btn);
        }
        
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          handleFormSubmit(e);
        });
      });
    });
  }
  
  function initializeButtonHoverEffects() {
    // Initialize hover effects for buttons with data-hover-bg attribute
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    const buttons = blockContainer.querySelectorAll('.footer .action.submit.classic-button[data-hover-bg], .footer .action.reset.classic-button[data-hover-bg]');
    
    buttons.forEach(function(button) {
      const hoverBg = button.getAttribute('data-hover-bg');
      
      if (hoverBg) {
        // Get original colors from inline style attribute
        const styleAttr = button.getAttribute('style') || '';
        let originalBg = '';
        let originalBorder = '';
        
        // Extract background-color and border-color from style attribute
        const bgMatch = styleAttr.match(/background-color:\s*([^;]+)/i);
        const borderMatch = styleAttr.match(/border-color:\s*([^;]+)/i);
        
        if (bgMatch) {
          originalBg = bgMatch[1].trim();
        } else {
          // Fallback to computed style
          originalBg = window.getComputedStyle(button).backgroundColor;
        }
        
        if (borderMatch) {
          originalBorder = borderMatch[1].trim();
        } else {
          // Fallback to computed style
          originalBorder = window.getComputedStyle(button).borderColor;
        }
        
        // Store original colors
        button.setAttribute('data-original-bg', originalBg);
        button.setAttribute('data-original-border', originalBorder);
        
        // Mouse enter - apply hover color to both background and border
        button.addEventListener('mouseenter', function() {
          this.style.backgroundColor = hoverBg;
          this.style.borderColor = hoverBg;
        });
        
        // Mouse leave - restore original colors
        button.addEventListener('mouseleave', function() {
          const origBg = this.getAttribute('data-original-bg') || originalBg;
          const origBorder = this.getAttribute('data-original-border') || originalBorder;
          this.style.backgroundColor = origBg;
          this.style.borderColor = origBorder;
        });
      }
    });
    
  }
  
  function initializeFloatingForm() {
    // Initialize floating form popup functionality
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    // Check if this is a floating form (has the floating-form-icon element)
    const floatingIcon = blockContainer.querySelector('.floating-form-icon');
    if (!floatingIcon) {
      return;
    }
    
    const overlay = blockContainer.querySelector('.floating-form-overlay');
    const closeBtn = blockContainer.querySelector('.floating-form-close');
    
    if (!overlay || !closeBtn) {
      return;
    }
    
    
    // Open popup when icon is clicked
    floatingIcon.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    });
    
    // Close popup when close button is clicked
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      overlay.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    });
    
    // Close popup when clicking outside the form
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      }
    });
    
    // Close popup on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      }
    });
    
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFormBuilder);
  } else {
    // DOM already loaded
    initializeFormBuilder();
  }
  
  // Also try after a short delay (for Theme Customizer)
  setTimeout(initializeFormBuilder, 100);
  
  // Listen for Shopify theme editor events
  if (typeof window.Shopify !== 'undefined' && window.Shopify.designMode) {
    document.addEventListener('shopify:section:load', initializeFormBuilder);
    document.addEventListener('shopify:block:select', initializeFormBuilder);
  }
})();
</script>

{% schema %}
{
  "name": "Easy Form Builder",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "text",
      "id": "form_id",
      "label": "Form ID",
      "info": "Enter the Form ID of the form you created in the Easy Form Builder app. You can find this ID in your app dashboard.",
      "default": "0"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "range",
      "id": "form_width",
      "label": "Form Width (%)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "form_alignment",
      "label": "Form Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}

