{% comment %}
  Dynamic Form Builder Block
  This is a SINGLE reusable block that works for ALL forms
  User enters Form ID in theme customizer settings
{% endcomment %}

<div id="easy-form-{{ block.id }}" 
     class="form-builder-container" 
     data-form-id="{{ block.settings.form_id }}"
     style="width: {{ block.settings.form_width }}%; margin: 0 auto; text-align: {{ block.settings.form_alignment }};">
  <div class="form-loading">Loading form...</div>
</div>

<script>
// Multiple strategies to ensure code runs in Theme Customizer
(function() {
  'use strict';
  
  async function initializeFormBuilder() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    
    if (!blockContainer) {
      console.warn('Block container not found for: easy-form-{{ block.id }}');
      return false;
    }
    
    // Get Form ID from block settings
    const formId = "{{ block.settings.form_id }}";
    
    // Validate Form ID (check for empty or default "0")
    if (!formId || formId.trim() === '' || formId.trim() === '0') {
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>⚠️ Form ID Required</strong><br>' +
        'Please enter a Form ID in the block settings to display the form.' +
        '</div>';
      console.warn('Form ID not provided in block settings');
      return false;
    }
    
    // Try different shop domain formats - Shopify might use different formats
    let shop = "{{ shop.permanent_domain }}";
    if (!shop || shop === "") {
      shop = "{{ shop.myshopify_domain }}";
    }
    if (!shop || shop === "") {
      shop = "{{ shop.domain }}";
    }
    // Fallback: try to get from window.location if available
    if (!shop || shop === "") {
      try {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      } catch(e) {
        console.warn('Could not get shop from window.location');
      }
    }
    
    console.log('=== Easy Form Builder Initialization ===');
    console.log('Block ID:', '{{ block.id }}');
    console.log('Form ID:', formId);
    console.log('Shop:', shop);
    
    // Load the form from app proxy
    try {
      const loadingDiv = blockContainer.querySelector('.form-loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      } else {
        blockContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      }
      
      console.log('Fetching form ID:', formId, 'for shop:', shop);
      const renderUrl = `/apps/easy-form-builder/render?form_id=${encodeURIComponent(formId)}&shop=${encodeURIComponent(shop)}`;
      console.log('Render URL:', renderUrl);
      
      const formResponse = await fetch(renderUrl, {
        method: 'GET',
        headers: {
          'Accept': 'text/html',
          'Content-Type': 'text/html'
        },
        credentials: 'same-origin'
      });
      
      console.log('Form response status:', formResponse.status);
      
      if (!formResponse.ok) {
        const errorText = await formResponse.text();
        console.error('Form response error:', errorText);
        throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
      }
      
      const formHtml = await formResponse.text();
      console.log('Form HTML received, length:', formHtml.length);
      
      if (formHtml && formHtml.trim().length > 0) {
        // Extract and execute scripts separately (innerHTML doesn't execute script tags)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formHtml;
        
        // Extract all script tags
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(function(oldScript) {
          const newScript = document.createElement('script');
          Array.from(oldScript.attributes).forEach(function(attr) {
            newScript.setAttribute(attr.name, attr.value);
          });
          newScript.textContent = oldScript.textContent;
          document.head.appendChild(newScript);
          oldScript.remove();
        });
        
        // Insert HTML without script tags
        blockContainer.innerHTML = tempDiv.innerHTML;
        console.log('✅ Form HTML inserted');
        
        // Remove readonly/disabled attributes from form fields so users can type
        const formInputs = blockContainer.querySelectorAll('input, textarea, select');
        console.log('=== Making Form Fields Editable ===');
        console.log('Found form inputs:', formInputs.length);
        formInputs.forEach(function(input, idx) {
          const name = input.name || input.getAttribute('name') || 'NO_NAME';
          const hadReadonly = input.hasAttribute('readonly');
          const wasDisabled = input.disabled;
          const hasTabindex = input.hasAttribute('tabindex');
          const tabindexValue = hasTabindex ? input.getAttribute('tabindex') : null;
          
          console.log(`Input ${idx} (${name}): BEFORE - readonly=${hadReadonly}, disabled=${wasDisabled}, tabindex=${tabindexValue}`);
          
          // Remove readonly
          if (hadReadonly) {
            input.removeAttribute('readonly');
            console.log(`Input ${idx} (${name}): Removed readonly attribute`);
          }
          
          // Enable disabled inputs
          if (wasDisabled) {
            input.disabled = false;
            console.log(`Input ${idx} (${name}): Enabled disabled input`);
          }
          
          // Remove negative tabindex (which prevents keyboard focus)
          if (hasTabindex && tabindexValue === '-1') {
            input.removeAttribute('tabindex');
            console.log(`Input ${idx} (${name}): Removed tabindex="-1"`);
          }
          
          // Ensure input is focusable and editable
          input.style.pointerEvents = 'auto';
          input.style.userSelect = 'auto';
          
          // Verify the input is now editable
          const isReadonly = input.readOnly;
          const isDisabled = input.disabled;
          const currentTabindex = input.hasAttribute('tabindex') ? input.getAttribute('tabindex') : 'none';
          console.log(`Input ${idx} (${name}): AFTER - readonly=${isReadonly}, disabled=${isDisabled}, tabindex=${currentTabindex}, canEdit=${!isReadonly && !isDisabled}`);
          
          // Test if we can set a value (to verify it's editable)
          const testValue = input.value;
          input.value = testValue + ''; // Try to set value
          const canSetValue = input.value !== undefined;
          console.log(`Input ${idx} (${name}): canSetValue=${canSetValue}, currentValue="${input.value.substring(0, 20)}"`);
        });
        console.log('✅ Form fields made editable');
        
        // Also use MutationObserver to catch any dynamically added readonly attributes
        if (typeof MutationObserver !== 'undefined') {
          const attrObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && (mutation.attributeName === 'readonly' || mutation.attributeName === 'disabled')) {
                const target = mutation.target;
                if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
                  if (target.hasAttribute('readonly')) {
                    target.removeAttribute('readonly');
                    console.log('MutationObserver: Removed readonly from', target.name || 'unnamed input');
                  }
                  if (target.disabled) {
                    target.disabled = false;
                    console.log('MutationObserver: Enabled', target.name || 'unnamed input');
                  }
                }
              }
            });
          });
          
          formInputs.forEach(function(input) {
            attrObserver.observe(input, {
              attributes: true,
              attributeFilter: ['readonly', 'disabled']
            });
          });
          
          console.log('✅ MutationObserver set up to prevent readonly/disabled from being re-added');
        }
        
        // Initialize form submission handler
        initializeFormSubmission();
        // Initialize button hover effects
        initializeButtonHoverEffects();
        // Initialize floating form functionality
        initializeFloatingForm();
      } else {
        throw new Error('Empty form HTML received');
      }
    } catch (error) {
      console.error('❌ Error loading form:', error);
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>Error loading form</strong><br>' +
        error.message + '<br>' +
        '<small>Please check that the Form ID is correct and the form exists in your app.</small>' +
        '</div>';
    }
  }
  
  function initializeFormSubmission() {
    console.log('=== Initializing Form Submission Handlers ===');
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    const forms = blockContainer.querySelectorAll('form.get_selected_elements');
    console.log('Found forms:', forms.length);
    
    forms.forEach(function(form, index) {
      console.log('Processing form', index);
      
      // Get form ID
      const formIdInput = form.querySelector('input[name="form_id"], input.form_id');
      const formId = formIdInput ? formIdInput.value : form.getAttribute('data-id') || '';
      console.log('Form ID:', formId);
      
      if (!formId) {
        console.error('Form ID not found for form', index);
        return;
      }
      
      // Get shop domain
      let shop = "{{ shop.permanent_domain }}";
      if (!shop || shop === "") {
        shop = "{{ shop.myshopify_domain }}";
      }
      if (!shop || shop === "") {
        shop = "{{ shop.domain }}";
      }
      if (!shop || shop === "") {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      }
      console.log('Shop domain:', shop);
      
      // Form submit handler
      function handleFormSubmit(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('=== FORM SUBMIT EVENT ===');
        console.log('Form:', form);
        console.log('Form ID:', formId);
        console.log('Shop:', shop);
        
        // Log all form inputs BEFORE modifying
        console.log('=== Form Inputs Debug (BEFORE) ===');
        const allInputs = form.querySelectorAll('input, textarea, select');
        console.log('Total inputs found:', allInputs.length);
        allInputs.forEach(function(input, idx) {
          const name = input.name || input.getAttribute('name') || 'NO_NAME';
          const value = input.value || input.getAttribute('value') || '';
          const type = input.type || input.tagName.toLowerCase();
          const disabled = input.disabled;
          const readonly = input.readOnly;
          const hasValue = value.trim().length > 0;
          console.log(`Input ${idx}: name="${name}", type="${type}", value="${value.substring(0, 50)}", disabled=${disabled}, readonly=${readonly}, hasValue=${hasValue}`);
        });
        
        // Remove readonly/disabled attributes temporarily to ensure values are collected
        const readonlyInputs = form.querySelectorAll('input[readonly], textarea[readonly]');
        const disabledInputs = form.querySelectorAll('input[disabled], textarea[disabled]');
        const readonlyStates = [];
        const disabledStates = [];
        
        console.log('Readonly inputs found:', readonlyInputs.length);
        console.log('Disabled inputs found:', disabledInputs.length);
        
        // Store and remove readonly
        readonlyInputs.forEach(function(input) {
          readonlyStates.push({element: input, name: input.name});
          input.removeAttribute('readonly');
          console.log('Removed readonly from:', input.name || 'unnamed input');
        });
        
        // Store and enable disabled inputs
        disabledInputs.forEach(function(input) {
          disabledStates.push({element: input, name: input.name});
          input.disabled = false;
          console.log('Enabled input:', input.name || 'unnamed input');
        });
        
        // Log inputs AFTER removing readonly/disabled
        console.log('=== Form Inputs Debug (AFTER removing readonly/disabled) ===');
        let hasAnyValue = false;
        allInputs.forEach(function(input, idx) {
          const name = input.name || input.getAttribute('name') || 'NO_NAME';
          const value = input.value || input.getAttribute('value') || '';
          const hasValue = value.trim().length > 0;
          const isReadonly = input.readOnly;
          const isDisabled = input.disabled;
          console.log(`Input ${idx}: name="${name}", value="${value.substring(0, 50)}", hasValue=${hasValue}, readonly=${isReadonly}, disabled=${isDisabled}`);
          if (hasValue) {
            hasAnyValue = true;
          }
        });
        
        // Warn if no values found
        if (!hasAnyValue) {
          console.error('❌ ERROR: No form fields have values!');
          console.error('This means the user cannot type in the fields or fields are being cleared.');
          console.error('Checking field editability...');
          
          // Test if we can set values programmatically
          allInputs.forEach(function(input, idx) {
            const name = input.name || 'NO_NAME';
            const testValue = 'TEST_VALUE_' + idx;
            const oldValue = input.value;
            input.value = testValue;
            const canSet = input.value === testValue;
            console.error(`Field ${idx} (${name}): canSetValue=${canSet}, oldValue="${oldValue}", newValue="${input.value}"`);
            // Restore old value
            input.value = oldValue;
          });
          
          // Show alert to user
          alert('Error: Form fields appear to be empty. Please ensure you can type in the form fields. If you cannot type, the form may have an issue. Check the browser console for details.');
          return false; // Stop submission
        }
        
        // Create FormData AFTER removing readonly/disabled
        const formData = new FormData(form);
        
        // Restore readonly/disabled states immediately
        readonlyStates.forEach(function(state) {
          state.element.setAttribute('readonly', 'readonly');
        });
        disabledStates.forEach(function(state) {
          state.element.disabled = true;
        });
        
        // Add system fields
        formData.append('store', shop);
        formData.append('routine_name', 'addformdata');
        formData.append('form_id', formId);
        
        // Log FormData entries
        console.log('=== FormData Entries ===');
        const formDataEntries = Array.from(formData.entries());
        console.log('Total FormData entries:', formDataEntries.length);
        formDataEntries.forEach(function(entry, idx) {
          console.log(`Entry ${idx}: ${entry[0]} = ${entry[1].toString().substring(0, 100)}`);
        });
        
        // Verify we have actual form data (not just system fields)
        const formFieldNames = [];
        formDataEntries.forEach(function(entry) {
          const key = entry[0];
          if (key !== 'store' && key !== 'routine_name' && key !== 'form_id' && key !== 'id') {
            formFieldNames.push(key);
          }
        });
        console.log('Form field names (excluding system fields):', formFieldNames);
        
        if (formFieldNames.length === 0) {
          console.error('ERROR: No form fields found! Form might be empty or fields have no name attributes.');
          console.error('Form HTML:', form.outerHTML.substring(0, 500));
          alert('Error: Form fields not found. Please check form configuration. Check console for details.');
          return false;
        }
        
        // Disable submit button
        const submitBtn = form.querySelector('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.6';
          const originalText = submitBtn.innerHTML;
          submitBtn.setAttribute('data-original-text', originalText);
          submitBtn.innerHTML = 'Submitting...';
        }
        
        // Get AJAX URL
        const ajaxUrl = 'https://codelocksolutions.com/form_builder/user/ajax_call.php';
        console.log('Submitting to:', ajaxUrl);
        
        // Submit via fetch
        console.log('=== Sending AJAX Request ===');
        console.log('URL:', ajaxUrl);
        console.log('Method: POST');
        console.log('FormData entries count:', formDataEntries.length);
        
        fetch(ajaxUrl, {
          method: 'POST',
          body: formData
        })
        .then(function(response) {
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);
          return response.text();
        })
        .then(function(responseText) {
          console.log('Response text:', responseText);
          let data;
          try {
            data = JSON.parse(responseText);
          } catch(e) {
            console.error('Failed to parse JSON:', e);
            console.error('Response was:', responseText);
            throw new Error('Invalid JSON response: ' + responseText.substring(0, 200));
          }
          console.log('Parsed response data:', data);
          
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
              submitBtn.innerHTML = originalText;
            }
          }
          
          if (data.result === 'success') {
            alert(data.msg || 'Form submitted successfully!');
            form.reset();
            console.log('Form reset');
          } else {
            alert(data.msg || 'Something went wrong. Please try again.');
          }
        })
        .catch(function(error) {
          console.error('Submission error:', error);
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            const originalText = submitBtn.getAttribute('data-original-text');
            if (originalText) {
              submitBtn.innerHTML = originalText;
            }
          }
          alert('An error occurred. Please check the console.');
        });
        
        return false;
      }
      
      // Attach submit handler to form
      form.addEventListener('submit', handleFormSubmit);
      console.log('Submit handler attached to form', index);
      
      // Also attach to submit buttons
      const submitButtons = form.querySelectorAll('button.submit, .submit.action, .footer-data__submittext, button[type="submit"], .action.submit, button.action.submit.classic-button');
      console.log('Found submit buttons:', submitButtons.length);
      
      submitButtons.forEach(function(btn, btnIndex) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('=== SUBMIT BUTTON CLICKED ===', btnIndex);
          handleFormSubmit(e);
        });
        console.log('Click handler attached to button', btnIndex);
      });
    });
  }
  
  function initializeButtonHoverEffects() {
    // Initialize hover effects for buttons with data-hover-bg attribute
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    const buttons = blockContainer.querySelectorAll('.footer .action.submit.classic-button[data-hover-bg], .footer .action.reset.classic-button[data-hover-bg]');
    
    buttons.forEach(function(button) {
      const hoverBg = button.getAttribute('data-hover-bg');
      
      if (hoverBg) {
        // Get original colors from inline style attribute
        const styleAttr = button.getAttribute('style') || '';
        let originalBg = '';
        let originalBorder = '';
        
        // Extract background-color and border-color from style attribute
        const bgMatch = styleAttr.match(/background-color:\s*([^;]+)/i);
        const borderMatch = styleAttr.match(/border-color:\s*([^;]+)/i);
        
        if (bgMatch) {
          originalBg = bgMatch[1].trim();
        } else {
          // Fallback to computed style
          originalBg = window.getComputedStyle(button).backgroundColor;
        }
        
        if (borderMatch) {
          originalBorder = borderMatch[1].trim();
        } else {
          // Fallback to computed style
          originalBorder = window.getComputedStyle(button).borderColor;
        }
        
        // Store original colors
        button.setAttribute('data-original-bg', originalBg);
        button.setAttribute('data-original-border', originalBorder);
        
        // Mouse enter - apply hover color to both background and border
        button.addEventListener('mouseenter', function() {
          this.style.backgroundColor = hoverBg;
          this.style.borderColor = hoverBg;
        });
        
        // Mouse leave - restore original colors
        button.addEventListener('mouseleave', function() {
          const origBg = this.getAttribute('data-original-bg') || originalBg;
          const origBorder = this.getAttribute('data-original-border') || originalBorder;
          this.style.backgroundColor = origBg;
          this.style.borderColor = origBorder;
        });
      }
    });
    
    console.log('Button hover effects initialized for', buttons.length, 'buttons');
  }
  
  function initializeFloatingForm() {
    // Initialize floating form popup functionality
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    if (!blockContainer) return;
    
    // Check if this is a floating form (has the floating-form-icon element)
    const floatingIcon = blockContainer.querySelector('.floating-form-icon');
    if (!floatingIcon) {
      console.log('Not a floating form, skipping floating form initialization');
      return;
    }
    
    const overlay = blockContainer.querySelector('.floating-form-overlay');
    const closeBtn = blockContainer.querySelector('.floating-form-close');
    
    if (!overlay || !closeBtn) {
      console.warn('Floating form elements not found');
      return;
    }
    
    console.log('Initializing floating form functionality');
    
    // Open popup when icon is clicked
    floatingIcon.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      console.log('Floating form popup opened');
    });
    
    // Close popup when close button is clicked
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      overlay.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
      console.log('Floating form popup closed');
    });
    
    // Close popup when clicking outside the form
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
        console.log('Floating form popup closed (clicked outside)');
      }
    });
    
    // Close popup on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        overlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
        console.log('Floating form popup closed (Escape key)');
      }
    });
    
    console.log('Floating form initialized successfully');
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFormBuilder);
  } else {
    // DOM already loaded
    initializeFormBuilder();
  }
  
  // Also try after a short delay (for Theme Customizer)
  setTimeout(initializeFormBuilder, 100);
  
  // Listen for Shopify theme editor events
  if (typeof window.Shopify !== 'undefined' && window.Shopify.designMode) {
    document.addEventListener('shopify:section:load', initializeFormBuilder);
    document.addEventListener('shopify:block:select', initializeFormBuilder);
  }
})();
</script>

{% schema %}
{
  "name": "Easy Form Builder",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "text",
      "id": "form_id",
      "label": "Form ID",
      "info": "Enter the Form ID of the form you created in the Easy Form Builder app. You can find this ID in your app dashboard.",
      "default": "0"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "range",
      "id": "form_width",
      "label": "Form Width (%)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "form_alignment",
      "label": "Form Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}

