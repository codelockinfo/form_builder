{% comment %}
  Template for generating form-specific blocks
  This file is used as a template to generate individual block files for each form
{% endcomment %}

<div id="easy-form-{{ block.id }}" class="form-builder-container" style="width: {{ block.settings.form_width }}%; margin: 0 auto; text-align: {{ block.settings.form_alignment }};">
  <div class="form-loading">Loading form...</div>
</div>

<script>
// Multiple strategies to ensure code runs in Theme Customizer
(function() {
  'use strict';
  
  async function initializeFormBuilder() {
    const blockContainer = document.getElementById("easy-form-{{ block.id }}");
    
    if (!blockContainer) {
      console.warn('Block container not found for: easy-form-{{ block.id }}');
      return false;
    }
    
    // Try different shop domain formats - Shopify might use different formats
    let shop = "{{ shop.permanent_domain }}";
    if (!shop || shop === "") {
      shop = "{{ shop.myshopify_domain }}";
    }
    if (!shop || shop === "") {
      shop = "{{ shop.domain }}";
    }
    // Fallback: try to get from window.location if available
    if (!shop || shop === "") {
      try {
        const hostname = window.location.hostname;
        if (hostname && hostname.includes('.myshopify.com')) {
          shop = hostname;
        }
      } catch(e) {
        console.warn('Could not get shop from window.location');
      }
    }
    
    // Form ID is hardcoded for this specific form block
    const formId = 19;
    const formName = "Regester to XYZ";
    
    console.log('=== Easy Form Builder Initialization ===');
    console.log('Block ID:', '{{ block.id }}');
    console.log('Form ID:', formId);
    console.log('Form Name:', formName);
    console.log('Shop:', shop);
    
    // Load the form directly (no need for dropdown since form_id is hardcoded)
    try {
      const loadingDiv = blockContainer.querySelector('.form-loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      } else {
        blockContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading form...</div>';
      }
      
      console.log('Fetching form ID:', formId, 'for shop:', shop);
      const renderUrl = `/apps/easy-form-builder/render?form_id=${formId}&shop=${encodeURIComponent(shop)}`;
      console.log('Render URL:', renderUrl);
      
      const formResponse = await fetch(renderUrl, {
        method: 'GET',
        headers: {
          'Accept': 'text/html',
          'Content-Type': 'text/html'
        },
        credentials: 'same-origin'
      });
      
      console.log('Form response status:', formResponse.status);
      
      if (!formResponse.ok) {
        const errorText = await formResponse.text();
        console.error('Form response error:', errorText);
        throw new Error(`Failed to load form: ${formResponse.status} ${formResponse.statusText}`);
      }
      
      const formHtml = await formResponse.text();
      console.log('Form HTML received, length:', formHtml.length);
      
      if (formHtml && formHtml.trim().length > 0) {
        blockContainer.innerHTML = formHtml;
        console.log('✅ Form HTML inserted');
        // Initialize form submission handler if needed
        initializeFormSubmission();
      } else {
        throw new Error('Empty form HTML received');
      }
    } catch (error) {
      console.error('❌ Error loading form:', error);
      blockContainer.innerHTML = '<div style="padding: 20px; color: #d32f2f; text-align: center; border: 2px solid #d32f2f; border-radius: 4px; background: #ffebee;">' +
        '<strong>Error loading form</strong><br>' +
        error.message + '<br>' +
        '<small style="margin-top: 10px; display: block;">Check browser console (F12) for details.</small>' +
        '</div>';
    }
    
    function initializeFormSubmission() {
      // Add form submission handling here if needed
      const form = blockContainer.querySelector('form.get_selected_elements');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          // Handle form submission
          console.log('Form submitted');
        });
      }
    }
    
    return true; // Success
  } // End of initializeFormBuilder
  
  // Multiple strategies to ensure code runs in Theme Customizer
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initializeFormBuilder();
  } else {
    document.addEventListener('DOMContentLoaded', initializeFormBuilder);
  }
  
  // Strategy 2: Retry after delays (Theme Customizer loads blocks dynamically)
  setTimeout(() => initializeFormBuilder(), 100);
  setTimeout(() => initializeFormBuilder(), 500);
  setTimeout(() => initializeFormBuilder(), 1000);
  setTimeout(() => initializeFormBuilder(), 2000);
  
  // Strategy 3: Listen for Shopify theme editor events
  if (typeof Shopify !== 'undefined' && Shopify.designMode) {
    document.addEventListener('shopify:section:load', function() {
      setTimeout(initializeFormBuilder, 100);
    });
  }
})();
</script>

{% schema %}
{
  "name": "Regester to XYZ Form",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Form Display Settings"
    },
    {
      "type": "range",
      "id": "form_width",
      "label": "Form Width (%)",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 100,
      "unit": "%"
    },
    {
      "type": "select",
      "id": "form_alignment",
      "label": "Form Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}

<style>
.form-builder-container {
  width: 100%;
}

.form-loading {
  text-align: center;
  padding: 20px;
  color: #637381;
}

.form-preview {
  max-width: 100%;
}

/* Form styles - adjust as needed to match your form design */
.form-builder-container .formHeader {
  margin-bottom: 20px;
}

.form-builder-container .formHeader .title {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 10px;
}

.form-builder-container .formHeader .description {
  font-size: 14px;
  color: #637381;
}

.form-builder-container form {
  width: 100%;
}

.form-builder-container .code-form-control {
  margin-bottom: 20px;
}

.form-builder-container .footer {
  margin-top: 30px;
  text-align: left;
}

.form-builder-container .footer.forFooterAlign {
  text-align: left;
}

.form-builder-container .footer.forFooterAlign.align-center {
  text-align: center;
}

.form-builder-container .footer.forFooterAlign.align-right {
  text-align: right;
}
</style>

