<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder - Test Storefront</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .test-header {
            background: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .test-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .test-controls label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .test-controls input, .test-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .test-controls button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-end;
        }
        
        .test-controls button:hover {
            background: #0056b3;
        }
        
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .debug-panel {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .debug-panel h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .debug-panel pre {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .console-log {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: #e7f3ff;
        }
        
        .console-error {
            border-left-color: #dc3545;
            background: #ffe7e7;
        }
        
        .console-success {
            border-left-color: #28a745;
            background: #e7f5e7;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>ðŸ§ª Form Builder - Test Storefront</h1>
        <p>Test your forms locally before deploying to Hostinger</p>
        
        <div class="test-controls">
            <label>
                <strong>Shop Domain:</strong>
                <input type="text" id="shopDomain" value="cls-rakshita.myshopify.com" placeholder="your-store.myshopify.com">
            </label>
            
            <label>
                <strong>Form ID (Public ID):</strong>
                <input type="text" id="formId" value="" placeholder="Enter 6-digit Form ID">
            </label>
            
            <label>
                <strong>Base URL:</strong>
                <select id="baseUrl">
                    <option value="http://localhost/form_builder" selected>Local (XAMPP) - Use for Testing</option>
                    <option value="http://127.0.0.1/form_builder">Local (127.0.0.1)</option>
                    <option value="https://codelocksolutions.com/form_builder">Production (Hostinger)</option>
                </select>
            </label>
            
            <button onclick="loadForm()">Load Form</button>
            <button onclick="clearForm()">Clear</button>
        </div>
    </div>
    
    <div class="form-container">
        <div id="formLoading" class="loading">Enter Form ID and click "Load Form" to test</div>
        <div id="formError" class="error" style="display: none;"></div>
        <div id="formContent"></div>
    </div>
    
    <div class="debug-panel">
        <h3>ðŸ“Š Debug Console</h3>
        <button onclick="clearConsole()" style="margin-bottom: 10px; padding: 5px 10px; font-size: 12px;">Clear Console</button>
        <div id="consoleOutput"></div>
    </div>
    
    <script>
        // Override console.log to show in debug panel
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(message, type = 'log') {
            const consoleOutput = document.getElementById('consoleOutput');
            const logDiv = document.createElement('div');
            logDiv.className = 'console-log console-' + type;
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            consoleOutput.appendChild(logDiv);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }
        
        // Mock Shopify object for testing
        window.Shopify = {
            shop: document.getElementById('shopDomain').value
        };
        
        function updateShopifyShop() {
            window.Shopify.shop = document.getElementById('shopDomain').value;
        }
        
        document.getElementById('shopDomain').addEventListener('change', updateShopifyShop);
        
        async function loadForm() {
            const shopDomain = document.getElementById('shopDomain').value.trim();
            const formId = document.getElementById('formId').value.trim();
            const baseUrl = document.getElementById('baseUrl').value;
            
            if (!shopDomain) {
                showError('Please enter a shop domain');
                return;
            }
            
            if (!formId) {
                showError('Please enter a Form ID');
                return;
            }
            
            updateShopifyShop();
            
            const loadingDiv = document.getElementById('formLoading');
            const errorDiv = document.getElementById('formError');
            const contentDiv = document.getElementById('formContent');
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '';
            
            console.log('=== Loading Form ===');
            console.log('Shop Domain:', shopDomain);
            console.log('Form ID:', formId);
            console.log('Base URL:', baseUrl);
            
            try {
                const renderUrl = `${baseUrl}/shopify/app-proxy.php/render?form_id=${encodeURIComponent(formId)}&shop=${encodeURIComponent(shopDomain)}`;
                console.log('Render URL:', renderUrl);
                
                loadingDiv.innerHTML = 'Loading form from server...';
                
                const response = await fetch(renderUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                    },
                    credentials: 'same-origin'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Failed to load form: ${response.status} ${response.statusText}\n${errorText}`);
                }
                
                const formHtml = await response.text();
                console.log('Form HTML received, length:', formHtml.length);
                console.log('Form HTML preview:', formHtml.substring(0, 500));
                
                if (!formHtml || formHtml.trim().length === 0) {
                    throw new Error('Form HTML is empty');
                }
                
                loadingDiv.style.display = 'none';
                contentDiv.innerHTML = formHtml;
                
                console.log('Form loaded successfully!');
                console.log('Form elements found:', contentDiv.querySelectorAll('form').length);
                console.log('Submit buttons found:', contentDiv.querySelectorAll('button.submit, .submit.action, .footer-data__submittext').length);
                
                // Attach form submission handlers after form is loaded
                setTimeout(() => {
                    attachFormHandlers();
                }, 100);
                
                // Check if scripts are loaded
                setTimeout(() => {
                    const scripts = document.querySelectorAll('script[src*="shopify_front"]');
                    console.log('Form scripts loaded:', scripts.length);
                    scripts.forEach((script, index) => {
                        console.log(`Script ${index + 1}:`, script.src);
                    });
                }, 1000);
                
            } catch (error) {
                console.error('Error loading form:', error);
                loadingDiv.style.display = 'none';
                showError('Failed to load form: ' + error.message);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('formError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function clearForm() {
            document.getElementById('formContent').innerHTML = '';
            document.getElementById('formLoading').style.display = 'block';
            document.getElementById('formLoading').innerHTML = 'Enter Form ID and click "Load Form" to test';
            document.getElementById('formError').style.display = 'none';
        }
        
        // Allow Enter key to trigger load
        document.getElementById('formId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadForm();
            }
        });
        
        // Function to attach form submission handlers
        function attachFormHandlers() {
            console.log('=== Attaching Form Submission Handlers ===');
            
            const shopDomain = document.getElementById('shopDomain').value.trim();
            
            // Find all forms
            const forms = document.querySelectorAll('form.get_selected_elements, form[class*="get_selected_elements"], form');
            console.log('Found forms:', forms.length);
            
            forms.forEach((form, formIndex) => {
                console.log(`Form ${formIndex + 1}:`, form);
                
                // Find form ID
                const formIdInput = form.querySelector('input[name="form_id"], input.form_id');
                const formId = formIdInput ? formIdInput.value : form.getAttribute('data-id') || 
                              form.closest('.form-builder-container')?.getAttribute('data-form-id') || '';
                console.log(`  Form ID: ${formId}`);
                
                // Attach submit event to form
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleFormSubmission(e, form, shopDomain, formId);
                });
                console.log(`  Submit handler attached to form ${formIndex + 1}`);
            });
            
            // Find all submit buttons
            const submitButtons = document.querySelectorAll(
                'button.submit, .submit.action, .footer-data__submittext, .classic-button.submit, ' +
                'button[class*="submit"], button.action.submit, .action.submit'
            );
            console.log('Found submit buttons:', submitButtons.length);
            
            submitButtons.forEach((btn, btnIndex) => {
                console.log(`Button ${btnIndex + 1}:`, btn, 'Classes:', btn.className);
                
                // Remove any existing listeners by cloning
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                // Find the form for this button
                const form = newBtn.closest('form') || document.querySelector('form.get_selected_elements') || document.querySelector('form');
                const formIdInput = form ? form.querySelector('input[name="form_id"], input.form_id') : null;
                const formId = formIdInput ? formIdInput.value : (form ? form.getAttribute('data-id') : '') || '';
                
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('=== SUBMIT BUTTON CLICKED ===');
                    console.log('Button:', newBtn);
                    console.log('Form:', form);
                    console.log('Form ID:', formId);
                    
                    if (form) {
                        handleFormSubmission(e, form, shopDomain, formId);
                    } else {
                        console.error('Form not found for button!');
                        alert('Form not found. Please refresh the page.');
                    }
                });
                console.log(`  Click handler attached to button ${btnIndex + 1}`);
            });
            
            console.log('=== Handlers Attached Successfully ===');
        }
        
        // Function to handle form submission
        function handleFormSubmission(e, form, shopDomain, formId) {
            console.log('=== HANDLE FORM SUBMISSION ===');
            console.log('Event:', e);
            console.log('Form:', form);
            console.log('Shop Domain:', shopDomain);
            console.log('Form ID:', formId);
            
            if (!form) {
                console.error('Form is null!');
                alert('Form not found. Please refresh the page.');
                return false;
            }
            
            if (!formId) {
                console.error('Form ID is missing!');
                // Try to get it again
                const formIdInput = form.querySelector('input[name="form_id"], input.form_id');
                formId = formIdInput ? formIdInput.value : form.getAttribute('data-id') || '';
                
                if (!formId) {
                    alert('Form ID is missing. Please refresh the page.');
                    return false;
                }
                console.log('Form ID found:', formId);
            }
            
            if (!shopDomain) {
                console.error('Shop domain is missing!');
                alert('Store information is missing. Please refresh the page.');
                return false;
            }
            
            // Create FormData
            const formData = new FormData(form);
            
            // Log all form fields BEFORE adding system fields
            console.log('=== Form Fields (from form) ===');
            const formFieldsBefore = {};
            for (let pair of formData.entries()) {
                formFieldsBefore[pair[0]] = pair[1];
            }
            console.log('Form fields:', formFieldsBefore);
            
            // Now add system fields
            formData.append('store', shopDomain);
            formData.append('routine_name', 'addformdata');
            formData.append('form_id', formId);
            
            console.log('=== Complete FormData being submitted ===');
            const allFormData = {};
            for (let pair of formData.entries()) {
                allFormData[pair[0]] = pair[1];
                console.log(`  ${pair[0]}: ${pair[1]}`);
            }
            console.log('Total fields:', Object.keys(allFormData).length);
            
            // Disable submit button
            const submitBtn = form.querySelector('button.submit, .submit.action, .footer-data__submittext, button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = 'Submitting...';
            }
            
            // Get base URL for AJAX call
            const baseUrl = document.getElementById('baseUrl').value;
            const ajaxUrl = `${baseUrl}/user/ajax_call.php`;
            
            console.log('Submitting to:', ajaxUrl);
            
            // Submit via fetch
            fetch(ajaxUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.text();
            })
            .then(text => {
                console.log('Response text:', text);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch(e) {
                    console.error('Failed to parse JSON:', e);
                    console.error('Response was:', text);
                    throw new Error('Invalid JSON response from server');
                }
                
                console.log('Response data:', data);
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.innerHTML = submitBtn.innerHTML.replace('Submitting...', 'Submit');
                }
                
                if (data.result === 'success') {
                    const msg = data.msg || 'Form submitted successfully!';
                    console.log('SUCCESS:', msg);
                    alert(msg);
                    
                    // Reset form
                    form.reset();
                    console.log('Form reset');
                } else {
                    const errorMsg = data.msg || 'Something went wrong. Please try again.';
                    console.error('ERROR:', errorMsg);
                    alert(errorMsg);
                }
            })
            .catch(error => {
                console.error('Submission error:', error);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.innerHTML = submitBtn.innerHTML.replace('Submitting...', 'Submit');
                }
                alert('An error occurred: ' + error.message + '\nPlease check the console for details.');
            });
            
            return false;
        }
        
        console.log('Test storefront page loaded');
        console.log('Ready to test forms!');
    </script>
</body>
</html>

